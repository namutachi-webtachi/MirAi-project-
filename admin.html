<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>MirAi Admin V3</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        body { background-color: #000; margin: 0; overflow: hidden; font-family: monospace; }
        
        /* MÃ n hÃ¬nh khÃ³a */
        #lock-screen {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: #0f0; z-index: 9999; background: black;
        }
        
        /* Admin Panel */
        #admin-panel { display: none; padding-bottom: 50px; background: #f4f4f4; min-height: 100vh; overflow-y: auto; }
        
        /* Danh sÃ¡ch chÆ°Æ¡ng */
        .chapter-row {
            display: flex; justify-content: space-between; align-items: center;
            background: white; padding: 10px; margin-bottom: 8px; border-radius: 8px;
            border: 1px solid #ddd;
        }
        .chapter-row:hover { border-color: var(--primary); background: #fff5f5; }
        .edit-btn { background: #f39c12; color: white; padding: 5px 15px; border-radius: 5px; cursor: pointer; border: none; }
        
        /* Tabs */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn { flex: 1; padding: 10px; cursor: pointer; background: #ddd; border: none; border-radius: 5px; font-weight: bold; }
        .tab-btn.active { background: var(--primary); color: white; }
    </style>
</head>
<body>

    <!-- MÃ€N HÃŒNH KHÃ“A -->
    <div id="lock-screen">
        <h1 style="font-size: 60px;">â˜ ï¸ RESTRICTED</h1>
        <p>GÃµ máº­t kháº©u trá»±c tiáº¿p Ä‘á»ƒ má»Ÿ khÃ³a...</p>
    </div>

    <!-- ADMIN TOOL -->
    <div id="admin-panel" class="container">
        <header class="glass-box" style="text-align: center; margin-top: 30px;">
            <h2 style="color: var(--primary);">âš™ï¸ QUáº¢N LÃ TRUYá»†N</h2>
            <a href="index.html" class="btn btn-outline">â¬… ThoÃ¡t</a>
        </header>

        <div class="glass-box">
            <h3>ğŸ”‘ Token GitHub</h3>
            <input type="password" id="token" placeholder="DÃ¡n Token vÃ o Ä‘Ã¢y..." onchange="saveToken()">
        </div>

        <!-- MENU CHá»ŒN CHá»¨C NÄ‚NG -->
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('new')">ğŸ“ ÄÄƒng Má»›i</button>
            <button class="tab-btn" onclick="switchTab('list')">ğŸ“‹ Quáº£n LÃ½ / Sá»­a</button>
        </div>

        <!-- TAB 1: ÄÄ‚NG Má»šI / SOáº N THáº¢O -->
        <div id="tab-editor" class="glass-box">
            <h3 id="editor-title">ğŸ“ Soáº¡n Tháº£o</h3>
            <input type="hidden" id="edit-id" value=""> <!-- LÆ°u ID khi sá»­a -->
            <input type="hidden" id="edit-file-sha" value=""> <!-- LÆ°u SHA file truyá»‡n -->
            
            <input type="text" id="chapTitle" placeholder="TiÃªu Ä‘á» chÆ°Æ¡ng">
            
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <div class="file-drop" style="flex: 1;" onclick="document.getElementById('txtInput').click()">
                    ğŸ“‚ Import TXT
                    <input type="file" id="txtInput" accept=".txt" hidden onchange="handleTxt()">
                </div>
                <div class="file-drop" style="flex: 1;" onclick="document.getElementById('imgInput').click()">
                    ğŸ–¼ Up áº¢nh
                    <input type="file" id="imgInput" accept="image/*" hidden onchange="handleImg()">
                </div>
            </div>
            <p id="imgStatus" style="text-align: center; color: blue; font-size: 0.8rem;"></p>

            <textarea id="content" rows="15" placeholder="Ná»™i dung..."></textarea>
            
            <button id="publishBtn" class="btn" onclick="publish()" style="width: 100%; margin-top: 10px;">ğŸš€ ÄÄ‚NG BÃ€I</button>
            <button id="cancelBtn" class="btn" onclick="resetForm()" style="width: 100%; margin-top: 10px; background: #7f8c8d; display: none;">Há»§y Sá»­a</button>
            <p id="status" style="text-align: center; font-weight: bold; margin-top: 10px;"></p>
        </div>

        <!-- TAB 2: DANH SÃCH CHÆ¯Æ NG -->
        <div id="tab-list" class="glass-box" style="display: none;">
            <h3>ğŸ“‹ Danh sÃ¡ch Ä‘Ã£ Ä‘Äƒng</h3>
            <button class="btn btn-outline" onclick="loadChapterList()" style="width: 100%; margin-bottom: 15px;">ğŸ”„ LÃ m má»›i danh sÃ¡ch</button>
            <div id="chapter-container">Äang táº£i...</div>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        // === ğŸ” Máº¬T KHáº¨U ===
        const PASS = "2006"; // Sá»­a máº­t kháº©u á»Ÿ Ä‘Ã¢y
        // ===================

        // Logic má»Ÿ khÃ³a
        let buffer = "";
        document.addEventListener('keydown', (e) => {
            if(e.key.length===1) {
                buffer += e.key;
                if(buffer.endsWith(PASS)) unlock();
            }
        });

        function unlock() {
            document.getElementById('lock-screen').style.display='none';
            document.getElementById('admin-panel').style.display='block';
            document.body.style.overflow='auto';
            if(localStorage.getItem('gh_token')) document.getElementById('token').value = localStorage.getItem('gh_token');
            if(typeof CONFIG !== 'undefined') document.body.style.backgroundImage = `url('${CONFIG.bgImage}')`;
        }

        // Chuyá»ƒn Tab
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            if(tab === 'new') {
                document.getElementById('tab-editor').style.display = 'block';
                document.getElementById('tab-list').style.display = 'none';
                document.querySelector('button[onclick="switchTab(\'new\')"]').classList.add('active');
            } else {
                document.getElementById('tab-editor').style.display = 'none';
                document.getElementById('tab-list').style.display = 'block';
                document.querySelector('button[onclick="switchTab(\'list\')"]').classList.add('active');
                loadChapterList();
            }
        }

        // Load danh sÃ¡ch chÆ°Æ¡ng Ä‘á»ƒ sá»­a
        async function loadChapterList() {
            const t = document.getElementById('token').value;
            if(!t) return alert("ChÆ°a nháº­p Token!");
            const container = document.getElementById('chapter-container');
            
            try {
                const res = await fetch(`https://api.github.com/repos/${CONFIG.adminUser}/${CONFIG.repoName}/contents/data.json?t=${Date.now()}`);
                const data = await res.json();
                const chapters = JSON.parse(decodeURIComponent(escape(atob(data.content))));
                
                container.innerHTML = '';
                chapters.forEach((chap, index) => {
                    container.innerHTML += `
                        <div class="chapter-row">
                            <div><b>#${index+1}:</b> ${chap.title}</div>
                            <button class="edit-btn" onclick="startEdit(${index})">âœï¸ Sá»­a</button>
                        </div>
                    `;
                });
                // LÆ°u SHA cá»§a data.json Ä‘á»ƒ dÃ¹ng khi update
                window.jsonSha = data.sha; 
                window.chapterData = chapters;
            } catch(e) { container.innerHTML = "Lá»—i táº£i danh sÃ¡ch: " + e; }
        }

        // Báº¯t Ä‘áº§u sá»­a chÆ°Æ¡ng
        async function startEdit(index) {
            const chap = window.chapterData[index];
            const t = document.getElementById('token').value;
            
            document.getElementById('status').innerText = "â³ Äang táº£i ná»™i dung chÆ°Æ¡ng...";
            switchTab('new'); // Quay vá» tab soáº¡n tháº£o
            
            try {
                // Láº¥y ná»™i dung file .md
                const res = await fetch(`https://api.github.com/repos/${CONFIG.adminUser}/${CONFIG.repoName}/contents/${chap.file}?t=${Date.now()}`);
                const data = await res.json();
                const content = decodeURIComponent(escape(atob(data.content)));
                
                // Äiá»n dá»¯ liá»‡u vÃ o form
                document.getElementById('chapTitle').value = chap.title;
                document.getElementById('content').value = content;
                document.getElementById('edit-id').value = index; // LÆ°u index Ä‘á»ƒ biáº¿t Ä‘ang sá»­a
                document.getElementById('edit-file-sha').value = data.sha; // LÆ°u SHA file md
                
                // Äá»•i giao diá»‡n sang cháº¿ Ä‘á»™ Sá»­a
                document.getElementById('editor-title').innerText = "âœï¸ Äang Sá»­a: " + chap.title;
                document.getElementById('publishBtn').innerText = "ğŸ’¾ Cáº¬P NHáº¬T CHÆ¯Æ NG";
                document.getElementById('publishBtn').style.background = "#f39c12";
                document.getElementById('cancelBtn').style.display = "block";
                document.getElementById('status').innerText = "";
            } catch(e) { alert("Lá»—i táº£i ná»™i dung: " + e); }
        }

        function resetForm() {
            document.getElementById('chapTitle').value = '';
            document.getElementById('content').value = '';
            document.getElementById('edit-id').value = '';
            document.getElementById('edit-file-sha').value = '';
            document.getElementById('editor-title').innerText = "ğŸ“ Soáº¡n Tháº£o";
            document.getElementById('publishBtn').innerText = "ğŸš€ ÄÄ‚NG BÃ€I";
            document.getElementById('publishBtn').style.background = "var(--primary)";
            document.getElementById('cancelBtn').style.display = "none";
        }

        // Logic ÄÄƒng / Cáº­p nháº­t
        async function publish() {
            const t = document.getElementById('token').value;
            const title = document.getElementById('chapTitle').value;
            const content = document.getElementById('content').value;
            const editIndex = document.getElementById('edit-id').value;
            const status = document.getElementById('status');

            if(!t || !title || !content) return alert("Thiáº¿u thÃ´ng tin!");
            status.innerText = "â³ Äang xá»­ lÃ½...";

            try {
                // 1. Láº¥y danh sÃ¡ch má»›i nháº¥t (Ä‘á»ƒ láº¥y SHA má»›i nháº¥t cá»§a data.json)
                const jsonRes = await fetch(`https://api.github.com/repos/${CONFIG.adminUser}/${CONFIG.repoName}/contents/data.json`, {headers:{Authorization:`token ${t}`}});
                const jsonData = await jsonRes.json();
                let list = JSON.parse(decodeURIComponent(escape(atob(jsonData.content))));
                let jsonSha = jsonData.sha;

                // XÃC Äá»ŠNH: ÄÄ‚NG Má»šI HAY Cáº¬P NHáº¬T?
                let filePath, fileSha = null;
                
                if (editIndex !== "") {
                    // --- CHáº¾ Äá»˜ Sá»¬A ---
                    const idx = parseInt(editIndex);
                    filePath = list[idx].file;
                    fileSha = document.getElementById('edit-file-sha').value; // SHA cá»§a file md cÅ©
                    
                    // Cáº­p nháº­t thÃ´ng tin trong list
                    list[idx].title = title;
                } else {
                    // --- CHáº¾ Äá»˜ ÄÄ‚NG Má»šI ---
                    const id = `chap_${Date.now()}`;
                    filePath = `chapters/${id}.md`;
                    list.push({ id: id, title: title, file: filePath });
                }

                // 2. Upload/Update file .md
                const b64 = btoa(unescape(encodeURIComponent(content)));
                const bodyMd = { message: `Update ${title}`, content: b64 };
                if (fileSha) bodyMd.sha = fileSha; // Náº¿u sá»­a thÃ¬ pháº£i gá»­i kÃ¨m SHA cÅ©

                await fetch(`https://api.github.com/repos/${CONFIG.adminUser}/${CONFIG.repoName}/contents/${filePath}`, {
                    method: 'PUT', headers: {Authorization: `token ${t}`}, body: JSON.stringify(bodyMd)
                });

                // 3. Update data.json
                const jsonB64 = btoa(unescape(encodeURIComponent(JSON.stringify(list, null, 2))));
                await fetch(`https://api.github.com/repos/${CONFIG.adminUser}/${CONFIG.repoName}/contents/data.json`, {
                    method: 'PUT', headers: {Authorization: `token ${t}`},
                    body: JSON.stringify({ message: "Update list", content: jsonB64, sha: jsonSha })
                });

                status.innerText = "ğŸ‰ THÃ€NH CÃ”NG!";
                setTimeout(() => {
                    status.innerText = "";
                    if(editIndex !== "") switchTab('list'); // Sá»­a xong thÃ¬ vá» danh sÃ¡ch
                    resetForm();
                }, 1500);

            } catch(e) { status.innerText = "âŒ Lá»—i: " + e; console.error(e); }
        }

        // Giá»¯ nguyÃªn cÃ¡c hÃ m helper cÅ©
        function saveToken() { localStorage.setItem('gh_token', document.getElementById('token').value); }
        function handleTxt() {
            const r = new FileReader();
            r.onload = e => document.getElementById('content').value = e.target.result.replace(/\r\n/g,"\n").replace(/\n/g,"\n\n");
            r.readAsText(document.getElementById('txtInput').files[0]);
        }
        async function handleImg() {
            const f = document.getElementById('imgInput').files[0];
            if(!f) return; const t = document.getElementById('token').value;
            document.getElementById('imgStatus').innerText = "Uploading...";
            const r = new FileReader(); r.readAsDataURL(f);
            r.onload = async function() {
                try {
                    const b64 = r.result.split(',')[1];
                    const n = `images/${Date.now()}_${f.name}`;
                    await fetch(`https://api.github.com/repos/${CONFIG.adminUser}/${CONFIG.repoName}/contents/${n}`, {
                        method:'PUT', headers:{Authorization:`token ${t}`}, body:JSON.stringify({message:"img",content:b64})
                    });
                    const url = `https://${CONFIG.adminUser}.github.io/${CONFIG.repoName}/${n}`;
                    const ta = document.getElementById('content');
                    ta.value = `![Img](${url})\n` + ta.value;
                    document.getElementById('imgStatus').innerText = "âœ… Done";
                } catch(e) { alert(e); }
            }
        }
    </script>
</body>
</html>
