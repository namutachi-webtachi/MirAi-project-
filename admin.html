<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá th·ªëng b√≠ m·∫≠t</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        /* CSS cho m√†n h√¨nh kh√≥a */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #2d3436; z-index: 99999;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
        }
        #app-content { display: none; } /* ·∫®n n·ªôi dung ch√≠nh */
        .login-box {
            background: white; padding: 30px; border-radius: 10px; text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .login-input { padding: 10px; font-size: 1.2rem; width: 200px; text-align: center; letter-spacing: 5px; }
    </style>
</head>
<body>

    <!-- üîí L·ªöP 1: M√ÄN H√åNH ƒêƒÇNG NH·∫¨P -->
    <div id="login-overlay">
        <div class="login-box">
            <h2 style="margin: 0 0 20px 0; color: #333;">üîí KHU V·ª∞C C·∫§M</h2>
            <p>Nh·∫≠p m√£ PIN ƒë·ªÉ truy c·∫≠p:</p>
            <input type="password" id="pinCode" class="login-input" placeholder="****" onkeyup="checkPin(event)">
            <p id="login-msg" style="color: red; margin-top: 10px;"></p>
        </div>
    </div>

    <!-- üîì L·ªöP 2: N·ªòI DUNG ADMIN (Ch·ªâ hi·ªán khi nh·∫≠p ƒë√∫ng pass) -->
    <div id="app-content" class="container">
        <header class="glass-box" style="text-align: center;">
            <h2>üõ† MirAi Admin Center</h2>
            <a href="index.html" class="btn btn-outline">‚¨Ö V·ªÅ Web Ch√≠nh</a>
        </header>

        <div class="glass-box">
            <h3>üîë Token GitHub</h3>
            <input type="password" id="token" placeholder="D√°n Token v√†o ƒë√¢y (ƒë∆∞·ª£c l∆∞u trong m√°y c·∫≠u)..." onchange="saveToken()">
        </div>

        <div class="glass-box">
            <h3>üìù So·∫°n th·∫£o & ƒêƒÉng b√†i</h3>
            
            <input type="text" id="chapTitle" placeholder="Ti√™u ƒë·ªÅ ch∆∞∆°ng (VD: Ch∆∞∆°ng 5)">

            <div class="file-drop" onclick="document.getElementById('txtInput').click()">
                <input type="file" id="txtInput" accept=".txt" hidden onchange="handleTxt()">
                üìÇ <b>Import file .TXT</b>
            </div>

            <div class="file-drop" onclick="document.getElementById('imgInput').click()">
                <input type="file" id="imgInput" accept="image/*" hidden onchange="handleImg()">
                üñº <b>Upload ·∫¢nh Minh H·ªça</b>
            </div>
            <p id="imgStatus" style="color: var(--primary); text-align: center;"></p>

            <textarea id="content" rows="15" placeholder="N·ªôi dung..."></textarea>
            
            <button class="btn" onclick="publish()" style="width: 100%; justify-content: center; font-size: 1.2rem; margin-top: 10px;">üöÄ ƒêƒÇNG NGAY</button>
            <div id="status" class="status"></div>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        // === üîê C·∫§U H√åNH M·∫¨T KH·∫®U T·∫†I ƒê√ÇY ===
        const SECRET_PIN = "2006"; // <--- ƒê·ªïi s·ªë n√†y th√†nh m·∫≠t kh·∫©u c·∫≠u mu·ªën (VD: NƒÉm sinh)
        // =====================================

        function checkPin(e) {
            const input = document.getElementById('pinCode').value;
            // N·∫øu nh·∫≠p ƒë·ªß ƒë·ªô d√†i pass th√¨ ki·ªÉm tra
            if (input === SECRET_PIN) {
                document.getElementById('login-overlay').style.display = 'none'; // ·∫®n m√†n h√¨nh kh√≥a
                document.getElementById('app-content').style.display = 'block';  // Hi·ªán admin
            } else if (input.length >= SECRET_PIN.length) {
                document.getElementById('login-msg').innerText = "Sai m√£ PIN r·ªìi c·∫≠u ∆°i!";
                document.getElementById('pinCode').value = '';
            }
        }

        // --- Code c≈© b√™n d∆∞·ªõi gi·ªØ nguy√™n ---
        if(localStorage.getItem('gh_token')) document.getElementById('token').value = localStorage.getItem('gh_token');
        function saveToken() { localStorage.setItem('gh_token', document.getElementById('token').value); }

        function handleTxt() {
            const file = document.getElementById('txtInput').files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                let text = e.target.result;
                text = text.replace(/\r\n/g, "\n").replace(/\n/g, "\n\n");
                document.getElementById('content').value = text;
            };
            reader.readAsText(file);
        }

        async function handleImg() {
            const file = document.getElementById('imgInput').files[0];
            if(!file) return;
            const token = document.getElementById('token').value;
            if(!token) return alert("Ch∆∞a nh·∫≠p Token!");

            document.getElementById('imgStatus').innerText = "‚è≥ ƒêang upload...";
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = async function() {
                try {
                    const base64 = reader.result.split(',')[1];
                    const fileName = `images/${Date.now()}_${file.name}`;
                    await githubReq(fileName, base64, "Up ·∫£nh", token);
                    
                    const imgUrl = `https://${CONFIG.adminUser}.github.io/${CONFIG.repoName}/${fileName}`;
                    const mdTag = `\n![Minh h·ªça](${imgUrl})\n`;
                    const txtArea = document.getElementById('content');
                    txtArea.value = mdTag + txtArea.value;
                    document.getElementById('imgStatus').innerText = "‚úÖ Xong!";
                } catch(e) { alert("L·ªói: " + e); }
            }
        }

        async function publish() {
            const token = document.getElementById('token').value;
            const title = document.getElementById('chapTitle').value;
            const content = document.getElementById('content').value;
            const status = document.getElementById('status');

            if(!token || !title || !content) return alert("Thi·∫øu th√¥ng tin!");
            
            status.innerText = "‚è≥ ƒêang x·ª≠ l√Ω...";
            status.style.color = "blue";

            try {
                const fileId = `chap_${Date.now()}`;
                const filePath = `chapters/${fileId}.md`;
                const contentB64 = btoa(unescape(encodeURIComponent(content)));
                await githubReq(filePath, contentB64, `New: ${title}`, token);

                const jsonUrl = `https://api.github.com/repos/${CONFIG.adminUser}/${CONFIG.repoName}/contents/data.json`;
                const getRes = await fetch(jsonUrl, { headers: {Authorization: `token ${token}`} });
                let list = [], sha = null;
                
                if(getRes.ok) {
                    const data = await getRes.json();
                    sha = data.sha;
                    list = JSON.parse(decodeURIComponent(escape(atob(data.content))));
                }

                list.push({ id: fileId, title: title, file: filePath });
                const jsonB64 = btoa(unescape(encodeURIComponent(JSON.stringify(list, null, 2))));
                await githubReq("data.json", jsonB64, "Update List", token, sha);

                status.innerText = "üéâ TH√ÄNH C√îNG!";
                status.style.color = "green";
                document.getElementById('content').value = '';
                document.getElementById('chapTitle').value = '';
            } catch(e) {
                status.innerText = "‚ùå L·ªói: " + e.message;
                status.style.color = "red";
            }
        }

        async function githubReq(path, content, msg, token, sha=null) {
            const body = { message: msg, content: content };
            if(sha) body.sha = sha;
            const res = await fetch(`https://api.github.com/repos/${CONFIG.adminUser}/${CONFIG.repoName}/contents/${path}`, {
                method: 'PUT',
                headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            if(!res.ok) throw new Error((await res.json()).message);
        }
    </script>
</body>
</html>
