<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MirAi Command Center</title>
    <!-- CSS Giao di·ªán ch√≠nh -->
    <link rel="stylesheet" href="css/style.css">
    <!-- CSS B·ªô so·∫°n th·∫£o vƒÉn b·∫£n -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.css">
    
    <style>
        /* --- GIAO DI·ªÜN RI√äNG CHO ADMIN --- */
        body { 
            background-color: #000; 
            margin: 0; 
            overflow: hidden; 
            font-family: 'Consolas', monospace; 
        }

        /* M√†n h√¨nh kh√≥a Hacker */
        #black-screen { 
            height: 100vh; width: 100vw; 
            display: flex; justify-content: center; align-items: center; 
            color: #0f0; font-size: 1.5rem; 
            background: black; z-index: 9999;
            transition: opacity 0.5s;
        }

        /* Khung l√†m vi·ªác ch√≠nh (M·∫∑c ƒë·ªãnh ·∫©n) */
        #admin-panel { 
            display: none; 
            padding-bottom: 50px; 
            background: #f4f4f4; 
            min-height: 100vh; 
            overflow-y: auto; 
            animation: fadeIn 0.5s; 
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Tabs chuy·ªÉn ƒë·ªïi */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .tab-btn { 
            flex: 1; padding: 12px; cursor: pointer; 
            background: #ddd; border: none; border-radius: 8px; 
            font-weight: bold; min-width: 120px; transition: 0.3s;
        }
        .tab-btn:hover { background: #ccc; }
        .tab-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }

        /* Khu v·ª±c k√©o th·∫£ file */
        .file-drop { 
            border: 2px dashed #aaa; padding: 20px; 
            text-align: center; border-radius: 10px; 
            cursor: pointer; margin-bottom: 15px; 
            background: white; font-weight: bold; color: #555; 
            transition: 0.3s; 
        }
        .file-drop:hover { 
            border-color: var(--primary); 
            background: rgba(255, 107, 129, 0.1); 
            color: var(--primary);
        }

        /* Form nh·∫≠p li·ªáu */
        input[type="text"], input[type="password"], input[type="datetime-local"] { 
            width: 100%; padding: 12px; 
            border: 1px solid #ccc; border-radius: 8px; 
            margin-bottom: 10px; font-family: inherit; 
            font-size: 1rem; box-sizing: border-box; 
        }

        /* T√πy ch·ªânh b·ªô so·∫°n th·∫£o EasyMDE */
        .EasyMDEContainer { background: white; border-radius: 8px; }
        .editor-toolbar { border-radius: 8px 8px 0 0; border-color: #ddd; }
        .CodeMirror { 
            border-radius: 0 0 8px 8px; border-color: #ddd; 
            min-height: 450px; font-size: 1.05rem; 
        }

        /* Danh s√°ch item (Truy·ªán, Nh√°p, Nh·∫°c) */
        .draft-item, .chapter-row { 
            background: white; padding: 15px; margin-bottom: 10px; 
            border-radius: 8px; border: 1px solid #eee; 
            display: flex; justify-content: space-between; align-items: center; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
        }
        .draft-item { border-left: 4px solid #f39c12; }
        .chapter-row { border-left: 4px solid var(--primary); }

        /* N√∫t b·∫•m nh·ªè */
        .btn-action { 
            padding: 6px 12px; border-radius: 6px; 
            cursor: pointer; border: none; color: white; 
            font-weight: bold; margin-left: 5px; font-size: 0.85rem; 
        }
        .edit-btn { background: #f39c12; } .edit-btn:hover { background: #d35400; }
        .del-btn { background: #e74c3c; } .del-btn:hover { background: #c0392b; }
        .open-btn { background: #3498db; } .open-btn:hover { background: #2980b9; }

        /* Th√¥ng b√°o ch√†o m·ª´ng */
        #welcome-toast { 
            position: fixed; top: 20px; right: 20px; 
            background: #27ae60; color: white; 
            padding: 15px 25px; border-radius: 8px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); 
            font-weight: bold; transform: translateX(200%); 
            transition: 0.5s; z-index: 10000; 
        }
        #welcome-toast.show { transform: translateX(0); }

        /* Khung h∆∞·ªõng d·∫´n */
        .guide-box { border: 1px dashed #ccc; background: #f9f9f9; border-radius: 8px; margin-bottom: 15px; }
        .guide-header { padding: 12px; cursor: pointer; font-weight: bold; user-select: none; }
        .guide-content { display: none; padding: 10px 15px; border-top: 1px dashed #ccc; }
        .guide-content ul { margin: 0; padding-left: 20px; }
    </style>
</head>
<body>

    <!-- Th√¥ng b√°o ch√†o m·ª´ng -->
    <div id="welcome-toast">üëã Welcome back, Commander.</div>

    <!-- 1. M√ÄN H√åNH KH√ìA (SECURITY LAYER) -->
    <div id="black-screen">
        <p>SYSTEM HALTED. PRESS F12 > CONSOLE > LOGIN.</p>
    </div>

    <!-- 2. GIAO DI·ªÜN ADMIN CH√çNH -->
    <div id="admin-panel" class="container">
        <header class="glass-box" style="text-align: center; margin-top: 30px;">
            <h2 style="color: var(--primary);">‚ò†Ô∏è MIRAI COMMAND CENTER</h2>
            <p style="color: #666;">H·ªá th·ªëng qu·∫£n tr·ªã t·ªëi th∆∞·ª£ng V7.1</p>
            <a href="index.html" class="btn btn-outline">‚¨Ö Quay v·ªÅ Trang ch·ªß</a>
        </header>

        <!-- C·∫§U H√åNH TOKEN -->
        <div class="glass-box">
            <h3>üîë C·∫•u h√¨nh & K·∫øt n·ªëi</h3>
            <input type="password" id="token" placeholder="GitHub Token (ghp_...)" onchange="saveConfig()">
            <input type="password" id="webhook" placeholder="Discord Webhook URL..." onchange="saveConfig()">
            <small style="color: #666;">*D·ªØ li·ªáu ƒë∆∞·ª£c m√£ h√≥a v√† l∆∞u an to√†n trong tr√¨nh duy·ªát c·ªßa b·∫°n.</small>
        </div>

        <!-- THANH ƒêI·ªÄU H∆Ø·ªöNG TAB -->
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('new')">üìù So·∫°n Th·∫£o</button>
            <button class="tab-btn" onclick="switchTab('drafts')">üíæ B·∫£n Nh√°p</button>
            <button class="tab-btn" onclick="switchTab('list')">üìã Qu·∫£n L√Ω Truy·ªán</button>
            <button class="tab-btn" onclick="switchTab('music')">üéµ DJ Station</button>
        </div>

        <!-- TAB 1: SO·∫†N TH·∫¢O (EDITOR) -->
        <div id="tab-editor" class="glass-box">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3 id="editor-title" style="margin: 0;">üìù So·∫°n Th·∫£o Ch∆∞∆°ng M·ªõi</h3>
                <span id="auto-save-status" style="font-size: 0.8rem; color: #aaa;">S·∫µn s√†ng</span>
            </div>
            <hr style="margin: 15px 0; border: 0; border-top: 1px dashed #ccc;">

            <!-- Bi·∫øn ·∫©n ƒë·ªÉ l∆∞u tr·∫°ng th√°i s·ª≠a -->
            <input type="hidden" id="edit-index" value="">
            <input type="hidden" id="edit-file-sha" value="">

            <input type="text" id="chapTitle" placeholder="Ti√™u ƒë·ªÅ ch∆∞∆°ng (V√≠ d·ª•: Ch∆∞∆°ng 1: Kh·ªüi ƒë·∫ßu)">
            
            <!-- H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng -->
            <div class="guide-box">
                <div class="guide-header" onclick="document.getElementById('gc').style.display=document.getElementById('gc').style.display=='block'?'none':'block'">
                    üìö Ph√≠m t·∫Øt & Quy t·∫Øc (B·∫•m ƒë·ªÉ xem)
                </div>
                <div class="guide-content" id="gc">
                    <ul>
                        <li><b>Ctrl + S:</b> L∆∞u b·∫£n nh√°p ngay l·∫≠p t·ª©c.</li>
                        <li><b>[T√™n]:</b> T·ª± ƒë·ªông in ƒë·∫≠m l·ªùi tho·∫°i (khi b·∫•m Auto Format).</li>
                        <li><b>(...)</b>: T·ª± ƒë·ªông in nghi√™ng suy nghƒ©.</li>
                        <li><b>***</b>: T·∫°o d√≤ng k·∫ª ngang chuy·ªÉn c·∫£nh.</li>
                    </ul>
                </div>
            </div>

            <!-- N√∫t c√¥ng c·ª• -->
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <div class="file-drop" style="flex:1" onclick="document.getElementById('txtInput').click()">
                    üìÇ Import File TXT 
                    <input type="file" id="txtInput" accept=".txt" hidden onchange="handleTxtImport()">
                </div>
                <div class="file-drop" style="flex:1" onclick="document.getElementById('imgInput').click()">
                    üñº Upload ·∫¢nh Minh H·ªça
                    <input type="file" id="imgInput" accept="image/*" hidden onchange="handleImgUpload()">
                </div>
            </div>
            <p id="imgStatus" style="text-align: center; color: blue; font-size: 0.9rem; margin-bottom: 10px;"></p>

            <button class="btn" onclick="runAutoFormat()" style="width: 100%; background: #2ecc71; margin-bottom: 15px;">
                ‚ú® T·ª± ƒê·ªông ƒê·ªãnh D·∫°ng (AI Format)
            </button>
            
            <!-- KHUNG SO·∫†N TH·∫¢O CH√çNH -->
            <textarea id="content"></textarea>
            
            <!-- Khu v·ª±c H·∫πn gi·ªù -->
            <div style="background: #f1f1f1; padding: 15px; border-radius: 8px; margin-top: 15px;">
                <label style="font-weight: bold;">‚è∞ H·∫πn gi·ªù ƒëƒÉng (T√πy ch·ªçn):</label>
                <input type="datetime-local" id="scheduleTime" style="margin-top: 5px; background: white;">
                <small>N·∫øu ƒë·ªÉ tr·ªëng, ch∆∞∆°ng s·∫Ω ƒë∆∞·ª£c ƒëƒÉng ngay l·∫≠p t·ª©c.</small>
            </div>

            <!-- N√∫t h√†nh ƒë·ªông -->
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn" onclick="saveDraft()" style="background: #f39c12; flex: 1;">üíæ L∆∞u Nh√°p (Ctrl+S)</button>
                <button id="publishBtn" class="btn" onclick="publishChapter()" style="flex: 1;">üöÄ ƒêƒÇNG B√ÄI</button>
            </div>
            
            <button id="cancelBtn" class="btn" onclick="resetForm()" style="width: 100%; margin-top: 10px; background: #7f8c8d; display: none;">
                H·ªßy Ch·∫ø ƒê·ªô S·ª≠a
            </button>
            
            <p id="status" style="text-align: center; font-weight: bold; margin-top: 15px; font-size: 1.1rem;"></p>
        </div>

        <!-- TAB 2: B·∫¢N NH√ÅP (DRAFTS) -->
        <div id="tab-drafts" class="glass-box" style="display: none;">
            <h3>üíæ Kho B·∫£n Nh√°p</h3>
            <p style="opacity: 0.7;">C√°c b√†i vi·∫øt ch∆∞a ho√†n thi·ªán ƒë∆∞·ª£c l∆∞u t·∫°i ƒë√¢y.</p>
            <div id="draft-list"></div>
        </div>

        <!-- TAB 3: QU·∫¢N L√ù (LIST) -->
        <div id="tab-list" class="glass-box" style="display: none;">
            <h3>üìã Danh s√°ch ch∆∞∆°ng ƒë√£ ƒëƒÉng</h3>
            <button class="btn btn-outline" onclick="loadChapterList()" style="width: 100%; margin-bottom: 15px;">üîÑ L√†m m·ªõi danh s√°ch</button>
            <div id="list-container">ƒêang t·∫£i d·ªØ li·ªáu...</div>
        </div>

        <!-- TAB 4: NH·∫†C (DJ STATION) -->
        <div id="tab-music" class="glass-box" style="display: none;">
            <h3>üéµ Upload Nh·∫°c M·ªõi</h3>
            <input type="text" id="songTitle" placeholder="T√™n b√†i h√°t (VD: Nh·∫°c n·ªÅn ƒëo·∫°n cao tr√†o)">
            <div class="file-drop" onclick="document.getElementById('mp3Input').click()">
                üíø Ch·ªçn file MP3 t·ª´ m√°y
                <input type="file" id="mp3Input" accept=".mp3" hidden>
            </div>
            <button class="btn" onclick="uploadMusic()" style="width: 100%;">‚¨ÜÔ∏è Upload v√†o Playlist</button>
            <p id="musicStatus" style="text-align: center; margin-top: 10px; font-weight: bold;"></p>
            
            <hr style="margin: 20px 0;">
            
            <h3>üéº Danh s√°ch ph√°t hi·ªán t·∫°i</h3>
            <button class="btn btn-outline" onclick="loadMusicList()" style="width: 100%; margin-bottom: 15px;">üîÑ L√†m m·ªõi Playlist</button>
            <div id="music-list-container">Loading...</div>
        </div>
    </div>

    <!-- SCRIPT LIBRARY -->
    <script src="config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.js"></script>
    
    <!-- SCRIPT LOGIC CH√çNH -->
    <script>
        const SECRET_PASS = "2006"; // M·∫≠t kh·∫©u c·ªßa bro
        
        // --- 1. KH·ªûI T·∫†O EDITOR ---
        var editor = new EasyMDE({ 
            element: document.getElementById("content"),
            spellChecker: false,
            placeholder: "Vi·∫øt g√¨ ƒë√≥ th·∫≠t ch√°y ƒëi Commander...",
            autosave: { 
                enabled: true, 
                uniqueId: "MirAi_AutoSave", 
                delay: 10000, 
            },
            status: ["lines", "words", "cursor"], 
            toolbar: ["bold", "italic", "heading", "|", "quote", "unordered-list", "ordered-list", "|", "link", "image", "|", "preview", "side-by-side", "fullscreen"] 
        });

        // B·∫Øt ph√≠m t·∫Øt Ctrl+S ƒë·ªÉ l∆∞u nh√°p
        document.addEventListener('keydown', e => {
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                saveDraft();
            }
        });

        // --- 2. H·ªÜ TH·ªêNG ƒêƒÇNG NH·∫¨P TH√îNG MINH ---
        document.addEventListener("DOMContentLoaded", () => {
            const token = localStorage.getItem('gh_token');
            // N·∫øu c√≥ token -> T·ª± ƒë·ªông v√†o lu√¥n
            if (token) { 
                unlockInterface(); 
                document.getElementById('token').value = token; 
                showWelcome();
            }
            // Load Webhook n·∫øu c√≥
            if (localStorage.getItem('discord_webhook')) {
                document.getElementById('webhook').value = localStorage.getItem('discord_webhook');
            }
            loadDraftsUI(); // Load b·∫£n nh√°p
        });

        function showWelcome() {
            const t = document.getElementById('welcome-toast');
            t.classList.add('show'); 
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        // H√†m login th·ªß c√¥ng (qua Console)
        window.login = function(pass) {
            if(pass === SECRET_PASS) { 
                unlockInterface(); 
                saveConfig(); 
                showWelcome(); 
            } else {
                console.log("WRONG PASS! ACCESS DENIED.");
            }
        }

        function unlockInterface() {
            document.getElementById('black-screen').style.display = 'none';
            document.getElementById('admin-panel').style.display = 'block';
            document.body.style.backgroundColor = "#f4f4f4";
            document.body.style.overflow = "auto";
            if(typeof CONFIG !== 'undefined') document.body.style.backgroundImage = `url('${CONFIG.bgImage}')`;
        }

        function saveConfig() { 
            localStorage.setItem('gh_token', document.getElementById('token').value);
            localStorage.setItem('discord_webhook', document.getElementById('webhook').value);
        }

        // --- 3. QU·∫¢N L√ù TAB ---
        function switchTab(t) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.glass-box[id^="tab-"]').forEach(d => d.style.display = 'none');
            
            let tabId = `tab-${t === 'new' ? 'editor' : t}`;
            document.getElementById(tabId).style.display = 'block';
            document.querySelector(`button[onclick="switchTab('${t}')"]`).classList.add('active');
            
            if(t === 'list') loadChapterList(); 
            if(t === 'music') loadMusicList();
        }

        // --- 4. H·ªÜ TH·ªêNG B·∫¢N NH√ÅP (DRAFTS) ---
        function saveDraft() {
            const title = document.getElementById('chapTitle').value;
            const content = editor.value();
            
            if(!title && !content) return alert("Vi·∫øt g√¨ ƒë√≥ tr∆∞·ªõc khi l∆∞u ch·ª©!");
            
            const drafts = JSON.parse(localStorage.getItem('mirai_drafts') || "[]");
            const newDraft = { 
                id: Date.now(), 
                title: title || "Kh√¥ng ti√™u ƒë·ªÅ", 
                content, 
                date: new Date().toLocaleString() 
            };
            
            // N·∫øu tr√πng t√™n -> Update, n·∫øu kh√¥ng -> Th√™m m·ªõi
            const idx = drafts.findIndex(d => d.title === title);
            if(idx !== -1 && title) drafts[idx] = newDraft;
            else drafts.unshift(newDraft);

            localStorage.setItem('mirai_drafts', JSON.stringify(drafts));
            
            const st = document.getElementById('auto-save-status');
            st.innerText = "‚úÖ ƒê√£ l∆∞u l√∫c " + new Date().toLocaleTimeString(); 
            st.style.color = "green";
            loadDraftsUI();
        }

        function loadDraftsUI() {
            const drafts = JSON.parse(localStorage.getItem('mirai_drafts') || "[]");
            const c = document.getElementById('draft-list');
            c.innerHTML = "";
            
            if(drafts.length === 0) c.innerHTML = "<p>Ch∆∞a c√≥ b·∫£n nh√°p n√†o.</p>";
            
            drafts.forEach((d, i) => {
                c.innerHTML += `
                    <div class="draft-item">
                        <div><b>${d.title}</b> <br> <small>${d.date}</small></div>
                        <div>
                            <button class="btn-action open-btn" onclick="openDraft(${i})">M·ªü</button>
                            <button class="btn-action del-btn" onclick="deleteDraft(${i})">X√≥a</button>
                        </div>
                    </div>`;
            });
        }

        function openDraft(i) {
            const drafts = JSON.parse(localStorage.getItem('mirai_drafts') || "[]");
            const d = drafts[i];
            document.getElementById('chapTitle').value = d.title;
            editor.value(d.content);
            switchTab('new');
        }

        function deleteDraft(i) {
            if(!confirm("X√≥a b·∫£n nh√°p n√†y?")) return;
            const drafts = JSON.parse(localStorage.getItem('mirai_drafts') || "[]");
            drafts.splice(i, 1);
            localStorage.setItem('mirai_drafts', JSON.stringify(drafts));
            loadDraftsUI();
        }

        // --- 5. C√îNG C·ª§ H·ªñ TR·ª¢ (IMPORT, UPLOAD, FORMAT) ---
        function handleTxtImport() { 
            const r = new FileReader(); 
            r.onload = e => { 
                let txt = e.target.result.replace(/\r\n/g,"\n").replace(/\n/g,"\n\n"); 
                editor.value(txt); 
            }; 
            r.readAsText(document.getElementById('txtInput').files[0]); 
        }

        async function handleImgUpload() { 
            const f = document.getElementById('imgInput').files[0]; 
            if(!f) return; 
            const t = document.getElementById('token').value; 
            
            document.getElementById('imgStatus').innerText = "‚è≥ ƒêang upload ·∫£nh..."; 
            const r = new FileReader(); 
            r.readAsDataURL(f);
            
            r.onload = async function(){ 
                try {
                    const b64 = r.result.split(',')[1]; 
                    const n = `images/${Date.now()}_${f.name}`; 
                    
                    await githubRequest(n, {message: "upload img", content: b64});
                    
                    const url = `https://${CONFIG.adminUser}.github.io/${CONFIG.repoName}/${n}`; 
                    
                    // --- ƒêO·∫†N FIX L·ªñI: CH√àN LINK V√ÄO EDITOR ---
                    const cm = editor.codemirror; 
                    const doc = cm.getDoc();
                    const cursor = doc.getCursor();
                    doc.replaceRange(`\n![Minh h·ªça](${url})\n`, cursor);
                    // ------------------------------------------
                    
                    document.getElementById('imgStatus').innerText = "‚úÖ ƒê√£ ch√®n ·∫£nh th√†nh c√¥ng!"; 
                } catch(e) { alert("L·ªói up ·∫£nh: " + e); } 
            } 
        }

        function runAutoFormat() {
            let txt = editor.value();
            // 1. Chu·∫©n h√≥a xu·ªëng d√≤ng
            txt = txt.replace(/\r\n/g,"\n").replace(/\n{2,}/g,"\n\n").replace(/(?<!\n)\n(?!\n)/g,"\n\n");
            // 2. In ƒë·∫≠m l·ªùi tho·∫°i [Ten]:
            txt = txt.replace(/^\[(.*?)\]:\s*(.*)$/gm, '**[$1]:** $2');
            // 3. In nghi√™ng suy nghƒ© (...)
            txt = txt.replace(/\((.*?)\)/g, '*($1)*');
            // 4. K·∫ª ngang chuy·ªÉn c·∫£nh
            txt = txt.replace(/^\s*\*\*\*\s*$/gm, '---');
            
            editor.value(txt);
            alert("‚úÖ ƒê√£ ƒë·ªãnh d·∫°ng vƒÉn b·∫£n chu·∫©n MirAi!");
        }

        // --- 6. X·ª¨ L√ù ƒêƒÇNG B√ÄI & DISCORD ---
        async function sendToDiscord(title, isScheduled, time) {
            const wh = document.getElementById('webhook').value; 
            if(!wh) return;
            
            let msg = isScheduled 
                ? `‚è≥ **L√äN L·ªäCH:** Ch∆∞∆°ng "${title}" s·∫Ω ph√°t h√†nh l√∫c: \`${new Date(time).toLocaleString()}\`!` 
                : `üéâ **CH∆Ø∆†NG M·ªöI:** **"${title}"** ƒë√£ l√™n s√≥ng!\nüëâ ƒê·ªçc ngay t·∫°i: https://${CONFIG.adminUser}.github.io/${CONFIG.repoName}`;
            
            try { 
                await fetch(wh, {
                    method:"POST",
                    headers:{"Content-Type":"application/json"},
                    body:JSON.stringify({content:msg, username:"MirAi Bot"})
                }); 
            } catch(e){ console.error("Discord Error:", e); }
        }

        async function publishChapter() {
            const t = document.getElementById('token').value;
            const title = document.getElementById('chapTitle').value;
            const content = editor.value();
            const editIdx = document.getElementById('edit-index').value;
            const scheduleInput = document.getElementById('scheduleTime').value;
            const status = document.getElementById('status');

            if(!t || !title || !content) return alert("Thi·∫øu th√¥ng tin (Token, Ti√™u ƒë·ªÅ, N·ªôi dung)!");
            
            status.innerText = "‚è≥ ƒêang k·∫øt n·ªëi m√°y ch·ªß GitHub...";
            status.style.color = "blue";

            try {
                // 1. L·∫•y danh s√°ch hi·ªán t·∫°i
                const jsonRes = await fetch(`https://api.github.com/repos/${CONFIG.adminUser}/${CONFIG.repoName}/contents/data.json`, {
                    headers:{Authorization:`token ${t}`}
                });
                const jsonData = await jsonRes.json();
                let list = JSON.parse(decodeURIComponent(escape(atob(jsonData.content))));
                
                // 2. X·ª≠ l√Ω th·ªùi gian
                let pubTime = Date.now(); 
                if(scheduleInput) pubTime = new Date(scheduleInput).getTime();
                
                // 3. Chu·∫©n b·ªã file
                let path, sha = null;
                const fileId = `chap_${Date.now()}`;
                
                if(editIdx !== "") { 
                    // Ch·∫ø ƒë·ªô S·ª≠a
                    path = list[editIdx].file;
                    sha = document.getElementById('edit-file-sha').value;
                    list[editIdx].title = title;
                    list[editIdx].timestamp = pubTime;
                } else { 
                    // Ch·∫ø ƒë·ªô M·ªõi
                    path = `chapters/${fileId}.md`;
                    list.push({id: fileId, title: title, file: path, timestamp: pubTime});
                }
                
                // 4. Upload file truy·ªán (.md)
                const contentB64 = btoa(unescape(encodeURIComponent(content)));
                const bodyMd = {message: `Update ${title}`, content: contentB64};
                if(sha) bodyMd.sha = sha; // N·∫øu s·ª≠a th√¨ g·ª≠i k√®m SHA c≈©
                
                await fetch(`https://api.github.com/repos/${CONFIG.adminUser}/${CONFIG.repoName}/contents/${path}`, {
                    method:'PUT', headers:{Authorization:`token ${t}`}, body:JSON.stringify(bodyMd)
                });
                
                // 5. C·∫≠p nh·∫≠t danh s√°ch (data.json)
                const jsonB64 = btoa(unescape(encodeURIComponent(JSON.stringify(list, null, 2))));
                await fetch(`https://api.github.com/repos/${CONFIG.adminUser}/${CONFIG.repoName}/contents/data.json`, {
                    method:'PUT', headers:{Authorization:`token ${t}`}, 
                    body:JSON.stringify({message: "Update Chapter List", content: jsonB64, sha: jsonData.sha})
                });
                
                // 6. G·ª≠i Discord
                await sendToDiscord(title, !!scheduleInput, pubTime);

                status.innerText = "‚úÖ TH√ÄNH C√îNG! ƒê√£ ƒëƒÉng b√†i.";
                status.style.color = "green";
                
                if(editIdx !== "") switchTab('list');
                else resetForm();

            } catch(e) { 
                status.innerText = "‚ùå L·ªói: " + e; 
                status.style.color = "red";
            }
        }

        // --- 7. C√ÅC H√ÄM QU·∫¢N L√ù ---
        function resetForm() { 
            document.getElementById('chapTitle').value=''; 
            editor.value(''); 
            document.getElementById('edit-index').value='';
            document.getElementById('edit-file-sha').value=''; 
            document.getElementById('publishBtn').innerText="üöÄ ƒêƒÇNG B√ÄI"; 
            document.getElementById('cancelBtn').style.display="none"; 
            document.getElementById('editor-title').innerText="üìù So·∫°n Th·∫£o"; 
            document.getElementById('scheduleTime').value=''; 
        }

        async function loadChapterList() { 
            const t = document.getElementById('token').value; 
            if(!t) return; 
            try {
                const res = await fetch(`https://api.github.com/repos/${CONFIG.adminUser}/${CONFIG.repoName}/contents/data.json?t=${Date.now()}`);
                const data = await res.json(); 
                window.chapters = JSON.parse(decodeURIComponent(escape(atob(data.content))));
                window.jsonSha = data.sha;
                
                const c = document.getElementById('list-container');
                c.innerHTML = '';
                if(window.chapters.length === 0) c.innerHTML = "Ch∆∞a c√≥ ch∆∞∆°ng n√†o.";
                
                window.chapters.forEach((h, i) => {
                    let status = (h.timestamp && h.timestamp > Date.now()) ? "‚è≥ (H·∫πn gi·ªù)" : "‚úÖ";
                    c.innerHTML += `
                        <div class="chapter-row">
                            <div>#${i+1}: ${h.title} <small>${status}</small></div>
                            <div class="action-group">
                                <button class="btn-action edit-btn" onclick="editChap(${i})">‚úèÔ∏è S·ª≠a</button>
                                <button class="btn-action del-btn" onclick="delChap(${i})">üóë X√≥a</button>
                            </div>
                        </div>`;
                });
            } catch(e) { document.getElementById('list-container').innerHTML = "L·ªói t·∫£i danh s√°ch: " + e; } 
        }

        async function editChap(i) { 
            const c = window.chapters[i];
            switchTab('new'); 
            try {
                const res = await fetch(`https://api.github.com/repos/${CONFIG.adminUser}/${CONFIG.repoName}/contents/${c.file}?t=${Date.now()}`);
                const d = await res.json(); 
                document.getElementById('chapTitle').value = c.title;
                editor.value(decodeURIComponent(escape(atob(d.content)))); 
                document.getElementById('edit-index').value = i;
                document.getElementById('edit-file-sha').value = d.sha; 
                document.getElementById('editor-title').innerText = "‚úèÔ∏è ƒêang S·ª≠a: " + c.title;
                document.getElementById('publishBtn').innerText = "üíæ C·∫¨P NH·∫¨T"; 
                document.getElementById('cancelBtn').style.display = "block";
            } catch(e) { alert("L·ªói t·∫£i ch∆∞∆°ng: " + e); } 
        }

        async function delChap(i) { 
            if(!confirm("C·∫£nh b√°o: B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a vƒ©nh vi·ªÖn ch∆∞∆°ng n√†y?")) return; 
            const t = document.getElementById('token').value; 
            try {
                const c = window.chapters[i]; 
                // X√≥a file truy·ªán
                const fR = await fetch(`https://api.github.com/repos/${CONFIG.adminUser}/${CONFIG.repoName}/contents/${c.file}`);
                const fD = await fR.json(); 
                await fetch(`https://api.github.com/repos/${CONFIG.adminUser}/${CONFIG.repoName}/contents/${c.file}`, {
                    method:'DELETE', headers:{Authorization:`token ${t}`}, 
                    body:JSON.stringify({message:"Del", sha:fD.sha})
                }); 
                
                // C·∫≠p nh·∫≠t danh s√°ch
                window.chapters.splice(i, 1);
                const jB = btoa(unescape(encodeURIComponent(JSON.stringify(window.chapters, null, 2)))); 
                await fetch(`https://api.github.com/repos/${CONFIG.adminUser}/${CONFIG.repoName}/contents/data.json`, {
                    method:'PUT', headers:{Authorization:`token ${t}`}, 
                    body:JSON.stringify({message:"Del item", content:jB, sha:window.jsonSha})
                }); 
                
                alert("ƒê√£ x√≥a ch∆∞∆°ng th√†nh c√¥ng!"); 
                loadChapterList();
            } catch(e) { alert("L·ªói khi x√≥a: " + e); } 
        }

        // --- 8. QU·∫¢N L√ù NH·∫†C (MUSIC STATION) ---
        async function loadMusicList() { 
            const c = document.getElementById('music-list-container'); 
            c.innerHTML = "ƒêang t·∫£i danh s√°ch nh·∫°c..."; 
            try {
                const res = await fetch(`https://api.github.com/repos/${CONFIG.adminUser}/${CONFIG.repoName}/contents/music.json?t=${Date.now()}`);
                const d = await res.json(); 
                window.musicData = JSON.parse(decodeURIComponent(escape(atob(d.content))));
                window.musicSha = d.sha; 
                
                c.innerHTML = ''; 
                if(window.musicData.length === 0) c.innerHTML = "Playlist tr·ªëng.";
                
                window.musicData.forEach((s, i) => {
                    c.innerHTML += `
                        <div class="chapter-row">
                            <div>üéµ ${s.title}</div>
                            <button class="btn-action del-btn" onclick="delSong(${i})">üóë X√≥a</button>
                        </div>`
                });
            } catch { c.innerHTML = "Ch∆∞a c√≥ Playlist."; window.musicData = []; } 
        }

        async function uploadMusic() { 
            const t = document.getElementById('token').value; 
            const ti = document.getElementById('songTitle').value; 
            const f = document.getElementById('mp3Input').files[0]; 
            if(!t || !ti || !f) return alert("Thi·∫øu th√¥ng tin upload!"); 
            
            document.getElementById('musicStatus').innerText = "‚è≥ ƒêang upload nh·∫°c..."; 
            
            const r = new FileReader(); 
            r.readAsDataURL(f); 
            r.onload = async function() { 
                try { 
                    const b64 = r.result.split(',')[1]; 
                    const p = `images/music/${Date.now()}_${f.name}`; 
                    
                    // Upload file MP3
                    await fetch(`https://api.github.com/repos/${CONFIG.adminUser}/${CONFIG.repoName}/contents/${p}`, {
                        method:'PUT', headers:{Authorization:`token ${t}`}, 
                        body:JSON.stringify({message:"Up Song", content:b64})
                    }); 
                    
                    // C·∫≠p nh·∫≠t music.json
                    if(!window.musicData) await loadMusicList(); 
                    window.musicData.push({title:ti, url:p}); 
                    
                    const jB = {
                        message: "Add song to playlist", 
                        content: btoa(unescape(encodeURIComponent(JSON.stringify(window.musicData, null, 2))))
                    }; 
                    if(window.musicSha) jB.sha = window.musicSha; 
                    
                    await fetch(`https://api.github.com/repos/${CONFIG.adminUser}/${CONFIG.repoName}/contents/music.json`, {
                        method:'PUT', headers:{Authorization:`token ${t}`}, body:JSON.stringify(jB)
                    }); 
                    
                    alert("Upload nh·∫°c th√†nh c√¥ng!"); 
                    document.getElementById('songTitle').value = ''; 
                    loadMusicList(); 
                } catch(e) { alert("L·ªói upload: " + e); } 
            } 
        }

        async function delSong(i) { 
            if(!confirm("X√≥a b√†i nh·∫°c n√†y?")) return; 
            const t = document.getElementById('token').value; 
            window.musicData.splice(i, 1); 
            
            const jB = {
                message: "Remove song", 
                content: btoa(unescape(encodeURIComponent(JSON.stringify(window.musicData, null, 2)))),
                sha: window.musicSha
            }; 
            
            await fetch(`https://api.github.com/repos/${CONFIG.adminUser}/${CONFIG.repoName}/contents/music.json`, {
                method:'PUT', headers:{Authorization:`token ${t}`}, body:JSON.stringify(jB)
            }); 
            
            alert("ƒê√£ x√≥a nh·∫°c!"); 
            loadMusicList(); 
        }

        // Helper function for generic requests
        async function githubRequest(path, body) {
            const t = document.getElementById('token').value;
            return fetch(`https://api.github.com/repos/${CONFIG.adminUser}/${CONFIG.repoName}/contents/${path}`, {
                method: 'PUT', headers: {Authorization: `token ${t}`}, body: JSON.stringify(body)
            });
        }
    </script>
</body>
</html>
