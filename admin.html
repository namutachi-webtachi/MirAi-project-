<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MirAi Command Center V16</title>
    
    <!-- CSS CHUNG & EDITOR -->
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.css">
    
    <style>
        /* --- CSS RIÃŠNG CHO ADMIN --- */
        body { background-color: #000; margin: 0; overflow: hidden; font-family: 'Consolas', monospace; transition: 0.3s; }
        
        /* MÃ n hÃ¬nh khÃ³a */
        #black-screen { 
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; 
            display: flex; justify-content: center; align-items: center; 
            color: #0f0; font-size: 1.2rem; background: black; z-index: 99999; 
            transition: opacity 0.5s; cursor: pointer; text-align: center;
        }

        /* Panel chÃ­nh */
        #admin-panel { 
            display: none; padding-bottom: 120px; background: #f4f4f4; 
            min-height: 100vh; overflow-y: auto; animation: fadeIn 0.5s; 
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Dark Mode Admin */
        [data-theme="dark"] #admin-panel { background: #1e1e1e; color: #e0e0e0; }
        [data-theme="dark"] .glass-box { background: rgba(40, 40, 40, 0.95); border-color: #555; }
        [data-theme="dark"] input, [data-theme="dark"] textarea, [data-theme="dark"] select { background: #2d2d2d; color: #fff; border-color: #555; }
        [data-theme="dark"] .file-drop { background: #2d2d2d; color: #aaa; border-color: #555; }
        [data-theme="dark"] .chapter-row, [data-theme="dark"] .draft-item, [data-theme="dark"] .ach-item, [data-theme="dark"] .prompt-container { background: #252525; border-color: #444; }
        
        /* Editor Dark Mode */
        [data-theme="dark"] .EasyMDEContainer { background: #2d2d2d; }
        [data-theme="dark"] .editor-toolbar { background: #333; border-color: #555; }
        [data-theme="dark"] .editor-toolbar i { color: #ccc; }
        [data-theme="dark"] .editor-toolbar i:hover { background: #555; }
        [data-theme="dark"] .CodeMirror { background: #252525; color: #ddd; border-color: #555; }
        [data-theme="dark"] .CodeMirror-cursor { border-left: 1px solid #fff; }

        /* UI Components */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .tab-btn { flex: 1; padding: 12px; cursor: pointer; background: #ddd; border: none; border-radius: 8px; font-weight: bold; min-width: 100px; transition: 0.3s; }
        .tab-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        [data-theme="dark"] .tab-btn { background: #444; color: #aaa; }
        [data-theme="dark"] .tab-btn.active { background: var(--primary); color: white; }

        .file-drop { border: 2px dashed #aaa; padding: 20px; text-align: center; border-radius: 10px; cursor: pointer; margin-bottom: 15px; background: white; font-weight: bold; color: #555; transition: 0.3s; }
        .file-drop:hover { border-color: var(--primary); background: rgba(255, 107, 129, 0.1); color: var(--primary); }

        input { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; margin-bottom: 10px; font-family: inherit; font-size: 1rem; box-sizing: border-box; }

        /* Editor Wrapper */
        .EasyMDEContainer { background: white; border-radius: 8px; margin-bottom: 15px; }
        .editor-toolbar { border-radius: 8px 8px 0 0; border-color: #ddd; }
        .CodeMirror { border-radius: 0 0 8px 8px; border-color: #ddd; min-height: 450px; font-size: 1.05rem; }

        /* Items */
        .draft-item, .chapter-row, .ach-item { background: white; padding: 15px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .draft-item { border-left: 4px solid #f39c12; }
        .chapter-row { border-left: 4px solid var(--primary); }
        .ach-item { border-left: 4px solid #f1c40f; }

        /* Buttons */
        .btn-action { padding: 6px 12px; border-radius: 6px; cursor: pointer; border: none; color: white; font-weight: bold; margin-left: 5px; font-size: 0.85rem; }
        .edit-btn { background: #f39c12; } 
        .del-btn { background: #e74c3c; } 
        .open-btn { background: #3498db; }
        .copy-btn { background: #9b59b6; width: auto; display: inline-block; padding: 5px 15px; font-size: 0.8rem; }

        /* Toast */
        #welcome-toast { position: fixed; top: 20px; right: 20px; background: #27ae60; color: white; padding: 15px 25px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); font-weight: bold; transform: translateX(200%); transition: 0.5s; z-index: 10000; }
        #welcome-toast.show { transform: translateX(0); }

        /* Guide & Prompt Box */
        .guide-box, .prompt-container { border: 1px dashed #ccc; background: #f9f9f9; border-radius: 8px; margin-bottom: 15px; overflow: hidden; }
        [data-theme="dark"] .guide-box, [data-theme="dark"] .prompt-container { background: #333; border-color: #555; }
        .guide-header { padding: 12px; cursor: pointer; font-weight: bold; user-select: none; display: flex; justify-content: space-between; }
        .guide-content { display: none; padding: 15px; border-top: 1px dashed #ccc; font-size: 0.9rem; line-height: 1.6; }
        .guide-content ul { margin: 0; padding-left: 20px; }
        .guide-content li { margin-bottom: 5px; }
        code { background: #e0e0e0; padding: 2px 5px; border-radius: 4px; font-family: monospace; color: #c0392b; font-weight: bold; }
        [data-theme="dark"] code { background: #444; color: #e74c3c; }
        
        /* Prompt Styling */
        .prompt-container { padding: 15px; }
        .prompt-title { font-weight: bold; color: var(--primary); display: block; margin-bottom: 5px; }
        .prompt-text { width: 100%; height: 80px; font-size: 0.85rem; font-family: monospace; resize: vertical; margin-bottom: 10px; }

        /* Logic Translator */
        .logic-input { font-family: 'Consolas', monospace; color: #d63031; font-weight: bold; }
        [data-theme="dark"] .logic-input { color: #55efc4; }

        /* Admin Player */
        #admin-player { position: fixed; bottom: 20px; left: 20px; background: rgba(0, 0, 0, 0.8); color: white; padding: 10px 20px; border-radius: 30px; display: flex; align-items: center; gap: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 10000; backdrop-filter: blur(5px); border: 1px solid var(--primary); transition: 0.3s; }
        #admin-player:hover { transform: scale(1.05); }
        #ap-icon { font-size: 1.5rem; animation: spin 4s linear infinite; animation-play-state: paused; }
        #ap-icon.playing { animation-play-state: running; }
        #ap-controls button { background: none; border: none; color: white; font-size: 1.2rem; cursor: pointer; }
        #ap-title { font-size: 0.9rem; max-width: 150px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="welcome-toast">ğŸ‘‹ Welcome back, Commander.</div>
    
    <!-- MÃ€N HÃŒNH KHÃ“A -->
    <div id="black-screen"><p>ğŸ›‘ SYSTEM HALTED.<br><br>GÃµ F12 hoáº·c <b>CHáº M</b> Ä‘á»ƒ Ä‘Äƒng nháº­p.</p></div>

    <div id="admin-panel" class="container">
        <header class="glass-box" style="text-align: center; margin-top: 30px;">
            <h2 style="color: var(--primary);">â˜ ï¸ MIRAI COMMAND CENTER</h2>
            <div style="margin-top: 15px;">
                <button class="btn" style="background: #34495e" onclick="toggleAdminTheme()">ğŸŒ— Äá»•i Giao diá»‡n</button>
                <a href="index.html" class="btn btn-outline" style="margin-top: 10px;">â¬… Quay vá» Web</a>
            </div>
        </header>

        <div class="glass-box">
            <h3>ğŸ”‘ Cáº¥u hÃ¬nh & Káº¿t ná»‘i</h3>
            <input type="password" id="token" placeholder="GitHub Token (ghp_...)" onchange="saveConfig()">
            <input type="password" id="webhook" placeholder="Discord Webhook URL..." onchange="saveConfig()">
            <small style="color: #666;">*Dá»¯ liá»‡u Ä‘Æ°á»£c lÆ°u an toÃ n trong trÃ¬nh duyá»‡t cá»§a báº¡n.</small>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('new')">ğŸ“ Soáº¡n Tháº£o</button>
            <button class="tab-btn" onclick="switchTab('drafts')">ğŸ’¾ Báº£n NhÃ¡p</button>
            <button class="tab-btn" onclick="switchTab('list')">ğŸ“‹ Quáº£n LÃ½ Truyá»‡n</button>
            <button class="tab-btn" onclick="switchTab('music')">ğŸµ DJ Station</button>
            <button class="tab-btn" style="background: #9b59b6; color: white;" onclick="switchTab('ailab')">ğŸ§  AI Lab</button>
            <button class="tab-btn" onclick="switchTab('achievements')">ğŸ† ThÃ nh Tá»±u</button>
        </div>

        <!-- TAB 1: EDITOR -->
        <div id="tab-editor" class="glass-box">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3 id="editor-title" style="margin: 0;">ğŸ“ Soáº¡n Tháº£o</h3>
                <span id="auto-save-status" style="font-size: 0.8rem; opacity: 0.7;">Sáºµn sÃ ng</span>
            </div>
            <hr style="margin: 15px 0; border: 0; border-top: 1px dashed #ccc;">
            <input type="hidden" id="edit-index" value=""><input type="hidden" id="edit-file-sha" value="">
            <input type="text" id="chapTitle" placeholder="TiÃªu Ä‘á» chÆ°Æ¡ng">
            
            <div class="guide-box">
                <div class="guide-header" onclick="toggleGuide('gc-editor')">ğŸ“š PhÃ­m táº¯t (Báº¥m xem) <span>â–¼</span></div>
                <div class="guide-content" id="gc-editor"><ul><li><b>Ctrl + S:</b> LÆ°u báº£n nhÃ¡p.</li><li><b>[TÃªn]:</b> Tá»± Ä‘á»™ng in Ä‘áº­m.</li><li><b>(...)</b>: Tá»± Ä‘á»™ng in nghiÃªng.</li><li><b>***</b>: Káº» ngang.</li></ul></div>
            </div>
            
            <div style="margin-bottom: 15px;">
                <a href="https://aistudio.google.com/prompts/1wYeI98PvvZuZZZTvg8D1SbIfJR6KveFO" target="_blank" class="btn" style="width: 100%; background: linear-gradient(45deg, #4285F4, #9B72CB); text-align: center; justify-content: center; box-sizing: border-box;">ğŸ§  Má»Ÿ AI Studio (Edit Truyá»‡n)</a>
            </div>

            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <div class="file-drop" style="flex:1" onclick="document.getElementById('txtInput').click()">ğŸ“‚ Import File TXT <input type="file" id="txtInput" accept=".txt" hidden onchange="handleTxtImport()"></div>
                <div class="file-drop" style="flex:1" onclick="document.getElementById('imgInput').click()">ğŸ–¼ Upload áº¢nh (NÃ©n) <input type="file" id="imgInput" accept="image/*" hidden onchange="handleImgUpload()"></div>
            </div>
            <p id="imgStatus" style="text-align: center; color: var(--primary); font-size: 0.9rem; margin-bottom: 10px; font-weight: bold;"></p>

            <button class="btn" onclick="runAutoFormat()" style="width: 100%; background: #2ecc71; margin-bottom: 15px;">âœ¨ Tá»± Äá»™ng Äá»‹nh Dáº¡ng (AI Format)</button>
            <textarea id="content"></textarea>
            
            <div style="background: rgba(0,0,0,0.05); padding: 15px; border-radius: 8px; margin-top: 15px;">
                <label style="font-weight: bold;">â° Háº¹n giá» Ä‘Äƒng (TÃ¹y chá»n):</label>
                <input type="datetime-local" id="scheduleTime" style="margin-top: 5px;">
                <small style="display: block; margin-top: 5px; opacity: 0.7;">Äá»ƒ trá»‘ng = ÄÄƒng ngay láº­p tá»©c.</small>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn" onclick="saveDraft()" style="background: #f39c12; flex: 1;">ğŸ’¾ LÆ°u NhÃ¡p</button>
                <button id="publishBtn" class="btn" onclick="publishChapter()" style="flex: 1;">ğŸš€ ÄÄ‚NG BÃ€I</button>
            </div>
            <button id="cancelBtn" class="btn" onclick="resetForm()" style="width: 100%; margin-top: 10px; background: #7f8c8d; display: none;">Há»§y Cháº¿ Äá»™ Sá»­a</button>
            <p id="status" style="text-align: center; font-weight: bold; margin-top: 15px; font-size: 1.1rem;"></p>
        </div>

        <div id="tab-drafts" class="glass-box" style="display: none;"><h3>ğŸ’¾ Kho Báº£n NhÃ¡p</h3><div id="draft-list"></div></div>
        <div id="tab-list" class="glass-box" style="display: none;"><h3>ğŸ“‹ Danh sÃ¡ch chÆ°Æ¡ng</h3><button class="btn btn-outline" onclick="loadChapterList()" style="width: 100%; margin-bottom: 15px;">ğŸ”„ LÃ m má»›i danh sÃ¡ch</button><div id="list-container">Loading...</div></div>
        
        <!-- TAB 4: MUSIC -->
        <div id="tab-music" class="glass-box" style="display: none;">
            <h3>ğŸµ Upload Nháº¡c</h3>
            <div class="guide-box"><div class="guide-header" onclick="toggleGuide('gc-music')">ğŸ§ HÆ°á»›ng dáº«n (Báº¥m má»Ÿ) <span>â–¼</span></div><div class="guide-content" id="gc-music">Upload file MP3, nháº¡c sáº½ tá»± vÃ o Playlist.</div></div>
            <input type="text" id="songTitle" placeholder="TÃªn bÃ i hÃ¡t">
            <div class="file-drop" onclick="document.getElementById('mp3Input').click()">ğŸ’¿ Chá»n MP3 <input type="file" id="mp3Input" accept=".mp3" hidden></div>
            <button class="btn" onclick="uploadMusic()" style="width: 100%;">â¬†ï¸ Upload</button>
            <p id="musicStatus" style="text-align: center; margin-top: 10px; font-weight: bold;"></p>
            <hr style="margin: 20px 0;">
            <button class="btn btn-outline" onclick="loadMusicList()" style="width: 100%; margin-bottom: 15px;">ğŸ”„ Refresh List</button>
            <div id="music-list-container">Loading...</div>
        </div>

        <!-- TAB 5: AI LAB -->
        <div id="tab-ailab" class="glass-box" style="display: none;">
            <h3>ğŸ§  AI Lab - PhÃ²ng ThÃ­ Nghiá»‡m</h3>
            <div class="prompt-container">
                <span class="prompt-title">ğŸ§‘â€ğŸ’» Thá»£ Code (Dev Lead)</span>
                <textarea class="prompt-text" id="prompt-dev">Role: Senior Frontend Developer. Project: MirAi Project (Static Site/JAMstack). Stack: HTML, CSS, JS, GitHub API. Nhiá»‡m vá»¥: Viáº¿t code sáº¡ch, tá»‘i Æ°u, khÃ´ng dÃ¹ng backend. Tráº£ lá»i: "ÄÃ£ nháº­n lá»‡nh".</textarea>
                <button class="btn-action copy-btn" onclick="copyPrompt('prompt-dev')">ğŸ“‹ Copy Prompt</button>
            </div>
            <div class="prompt-container">
                <span class="prompt-title">ğŸ¨ Art Director (Váº½ tranh)</span>
                <textarea class="prompt-text" id="prompt-art">Báº¡n lÃ  Art Director cho MirAi. Cáº¤U TRÃšC: (Quality Tags), (Art Style: makoto shinkai), (NhÃ¢n váº­t: Minh/Vy), (Bá»‘i cáº£nh). INPUT: Äoáº¡n vÄƒn tiáº¿ng Viá»‡t. OUTPUT: Positive & Negative prompt.</textarea>
                <button class="btn-action copy-btn" onclick="copyPrompt('prompt-art')">ğŸ“‹ Copy Prompt</button>
            </div>
            <hr style="margin: 20px 0; border-top: 1px dashed #ccc;">
            <div class="guide-box">
                <div class="guide-header" onclick="toggleGuide('gc-logic')">ğŸ§ª Logic Lab (MÃ¡y Dá»‹ch) <span>â–¼</span></div>
                <div class="guide-content" id="gc-logic">
                    <label>Nháº­p tiáº¿ng Viá»‡t (VD: giá» lá»›n hÆ¡n 22):</label>
                    <input type="text" id="humanLogic">
                    <button class="btn" onclick="translateLogic()" style="background: #9b59b6; margin-top:5px;">ğŸ”„ Dá»‹ch</button>
                    <input type="text" id="logicResult" class="logic-input" readonly placeholder="Káº¿t quáº£..." style="margin-top:5px;">
                </div>
            </div>
        </div>

        <!-- TAB 6: ACHIEVEMENTS -->
        <div id="tab-achievements" class="glass-box" style="display: none;">
            <h3>ğŸ† Quáº£n LÃ½ ThÃ nh Tá»±u</h3>
            <div class="guide-box"><div class="guide-header" onclick="toggleGuide('gc-ach')">ğŸ… HÆ°á»›ng dáº«n (Báº¥m má»Ÿ) <span>â–¼</span></div><div class="guide-content" id="gc-ach"><ul><li>B1: Sang <b>AI Lab</b> dá»‹ch logic.</li><li>B2: Äiá»n thÃ´ng tin bÃªn dÆ°á»›i.</li><li>B3: Paste mÃ£ vÃ o Ã´ cuá»‘i.</li></ul></div></div>
            <div style="background: rgba(0,0,0,0.05); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <label>ID:</label><input type="text" id="achId" placeholder="VD: night_owl">
                <label>Icon:</label><input type="text" id="achIcon" placeholder="VD: ğŸ¦‰">
                <label>TÃªn:</label><input type="text" id="achTitle" placeholder="VD: CÃº ÄÃªm">
                <label>MÃ´ táº£:</label><input type="text" id="achDesc" placeholder="VD: Äá»c truyá»‡n lÃºc ná»­a Ä‘Ãªm">
                <label style="color: var(--primary);">âš™ï¸ Äiá»u kiá»‡n (Code):</label><input type="text" id="achCondition" placeholder="Paste code vÃ o Ä‘Ã¢y...">
                <button class="btn" onclick="addAchievement()" style="width: 100%; margin-top: 10px;">â• ThÃªm</button>
            </div>
            <button class="btn btn-outline" onclick="loadAchievements()" style="width: 100%; margin-bottom: 15px;">ğŸ”„ Refresh List</button>
            <div id="ach-list-container">Loading...</div>
        </div>
    </div>

    <!-- ADMIN PLAYER -->
    <div id="admin-player" style="display: none;">
        <div id="ap-icon">ğŸ’¿</div><div id="ap-info"><div id="ap-title">Loading...</div></div><div id="ap-controls"><button onclick="toggleAdminMusic()" id="ap-play-btn">â–¶ï¸</button><button onclick="nextAdminMusic()">â­ï¸</button></div>
    </div>

    <!-- LIB -->
    <script src="config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/compressorjs/1.2.1/compressor.min.js"></script>
    
    <!-- JS LOGIC -->
    <script>
        const SECRET_PASS = "2006";
        
        // EDITOR SETUP
        var editor = new EasyMDE({ 
            element: document.getElementById("content"), spellChecker: false, placeholder: "Viáº¿t gÃ¬ Ä‘Ã³ tháº­t chÃ¡y Ä‘i Commander...", autosave: { enabled: true, uniqueId: "MirAi_AutoSave", delay: 10000 },
            status: ["lines", { className: "words", defaultValue: function(el){el.innerHTML="0 words"}, onUpdate: function(el){ var txt = editor.value().replace(/!\[.*?\]\(.*?\)/g, "").replace(/\[.*?\]\(.*?\)/g, "").replace(/[#*`~>]/g, "").replace(/[.,:;!?(){}"'\[\]\-]/g, " "); var wc = txt.trim().split(/\s+/).filter(n => n != "").length; el.innerHTML = wc + " words"; }}, "cursor"], 
            toolbar: ["bold", "italic", "heading", "|", "quote", "unordered-list", "ordered-list", "|", "link", "image", "|", "preview", "side-by-side", "fullscreen"] 
        });
        document.addEventListener('keydown', e => { if (e.ctrlKey && e.key === 's') { e.preventDefault(); saveDraft(); } });

        // AUTH & INIT
        document.addEventListener("DOMContentLoaded", () => {
            if (localStorage.getItem('admin_theme') === 'dark') document.body.setAttribute('data-theme', 'dark');
            const token = localStorage.getItem('gh_token');
            if (token) { unlockInterface(); document.getElementById('token').value = token; showWelcome(); initAdminMusic(); }
            if (localStorage.getItem('discord_webhook')) document.getElementById('webhook').value = localStorage.getItem('discord_webhook');
            loadDraftsUI();
        });
        document.getElementById('black-screen').addEventListener('click', () => { let pass = prompt("ğŸ”’ Máº­t mÃ£:"); if (pass === SECRET_PASS) { unlockInterface(); saveConfig(); showWelcome(); initAdminMusic(); } else if (pass) { alert("SAI!"); } });
        
        function showWelcome() { const t = document.getElementById('welcome-toast'); t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 3000); }
        window.login = function(pass) { if(pass === SECRET_PASS) { unlockInterface(); saveConfig(); showWelcome(); initAdminMusic(); } else console.log("WRONG PASS"); }
        function unlockInterface() { document.getElementById('black-screen').style.display = 'none'; document.getElementById('admin-panel').style.display = 'block'; document.body.style.backgroundColor = "#f4f4f4"; document.body.style.overflow = "auto"; if(typeof CONFIG !== 'undefined') document.body.style.backgroundImage = `url('${CONFIG.bgImage}')`; document.getElementById('admin-player').style.display = 'flex'; }
        function saveConfig() { localStorage.setItem('gh_token', document.getElementById('token').value); localStorage.setItem('discord_webhook', document.getElementById('webhook').value); }
        function toggleAdminTheme() { const body = document.body; const current = body.getAttribute('data-theme'); const next = current === 'dark' ? 'light' : 'dark'; body.setAttribute('data-theme', next); localStorage.setItem('admin_theme', next); }
        function toggleGuide(id) { const el = document.getElementById(id); el.style.display = (el.style.display === 'block') ? 'none' : 'block'; }
        function switchTab(t) { document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); document.querySelectorAll('.glass-box[id^="tab-"]').forEach(d => d.style.display = 'none'); document.getElementById(`tab-${t === 'new' ? 'editor' : (t === 'ailab' ? 'tab-ailab' : 'tab-' + t)}`).style.display = 'block'; document.querySelector(`button[onclick="switchTab('${t}')"]`).classList.add('active'); if(t === 'list') loadChapterList(); if(t === 'music') loadMusicList(); if(t === 'achievements') loadAchievements(); }

        // DRAFTS
        function saveDraft() { const title = document.getElementById('chapTitle').value; const content = editor.value(); if(!title && !content) return alert("Viáº¿t gÃ¬ Ä‘Ã³ Ä‘Ã£!"); const drafts = JSON.parse(localStorage.getItem('mirai_drafts') || "[]"); const newDraft = { id: Date.now(), title: title || "KhÃ´ng tiÃªu Ä‘á»", content, date: new Date().toLocaleString() }; const idx = drafts.findIndex(d => d.title === title); if(idx !== -1 && title) drafts[idx] = newDraft; else drafts.unshift(newDraft); localStorage.setItem('mirai_drafts', JSON.stringify(drafts)); document.getElementById('auto-save-status').innerText = "âœ… ÄÃ£ lÆ°u " + new Date().toLocaleTimeString(); document.getElementById('auto-save-status').style.color = "green"; loadDraftsUI(); }
        function loadDraftsUI() { const drafts = JSON.parse(localStorage.getItem('mirai_drafts') || "[]"); const c = document.getElementById('draft-list'); c.innerHTML = drafts.length ? "" : "<p>ChÆ°a cÃ³ báº£n nhÃ¡p.</p>"; drafts.forEach((d, i) => { c.innerHTML += `<div class="draft-item"><div><b>${d.title}</b> <br> <small>${d.date}</small></div><div><button class="btn-action open-btn" onclick="openDraft(${i})">Má»Ÿ</button><button class="btn-action del-btn" onclick="deleteDraft(${i})">XÃ³a</button></div></div>`; }); }
        function openDraft(i) { const drafts = JSON.parse(localStorage.getItem('mirai_drafts') || "[]"); document.getElementById('chapTitle').value = drafts[i].title; editor.value(drafts[i].content); switchTab('new'); }
        function deleteDraft(i) { if(!confirm("XÃ³a nhÃ¡p?")) return; const drafts = JSON.parse(localStorage.getItem('mirai_drafts') || "[]"); drafts.splice(i, 1); localStorage.setItem('mirai_drafts', JSON.stringify(drafts)); loadDraftsUI(); }
        
        // TOOLS
        function handleTxtImport() { const r = new FileReader(); r.onload = e => { let txt = e.target.result.replace(/\r\n/g,"\n").replace(/\n/g,"\n\n"); editor.value(txt); }; r.readAsText(document.getElementById('txtInput').files[0]); }
        async function handleImgUpload() { const f = document.getElementById('imgInput').files[0]; if(!f) return; const t = document.getElementById('token').value; document.getElementById('imgStatus').innerText = "â³ NÃ©n áº£nh..."; new Compressor(f, { quality: 0.6, maxWidth: 1200, mimeType: 'image/jpeg', success(result) { document.getElementById('imgStatus').innerText = "â³ Uploading..."; const r = new FileReader(); r.readAsDataURL(result); r.onload = async function() { try { const b64 = r.result.split(',')[1]; const n = `images/${Date.now()}_opt.jpg`; await githubRequest(n, {message: "up img", content: b64}); const url = `https://${CONFIG.adminUser}.github.io/${CONFIG.repoName}/${n}`; editor.codemirror.getDoc().replaceRange(`\n![Minh há»a](${url})\n`, editor.codemirror.getDoc().getCursor()); document.getElementById('imgStatus').innerText = "âœ… Done!"; } catch(e) { alert("Lá»—i: " + e); document.getElementById('imgStatus').innerText=""; } }; }, error(err) { alert(err.message); } }); }
        function runAutoFormat() { let txt = editor.value().replace(/\r\n/g,"\n").replace(/\n{2,}/g,"\n\n").replace(/(?<!\n)\n(?!\n)/g,"\n\n").replace(/^\[(.*?)\]:\s*(.*)$/gm, '**[$1]:** $2').replace(/\((.*?)\)/g, '*($1)*').replace(/^\s*\*\*\*\s*$/gm, '---'); editor.value(txt); alert("âœ… ÄÃ£ Ä‘á»‹nh dáº¡ng!"); }
        function copyPrompt(id) { const t = document.getElementById(id); t.select(); document.execCommand('copy'); alert("ÄÃ£ copy Prompt!"); }
        function translateLogic() { let text = document.getElementById('humanLogic').value.toLowerCase(); const dict = [ { k:['giá»','thá»i gian'], v:'env.hour' }, { k:['sá»‘ chÆ°Æ¡ng','Ä‘Ã£ Ä‘á»c','Ä‘á»c Ä‘Æ°á»£c'], v:'env.readCount' }, { k:['cuá»™n','lÆ°á»›t'], v:'env.scroll' }, { k:['chÆ°Æ¡ng sá»‘','id chÆ°Æ¡ng'], v:'env.chapId' }, { k:['lá»›n hÆ¡n hoáº·c báº±ng','tá»«'], v:'>=' }, { k:['nhá» hÆ¡n hoáº·c báº±ng'], v:'<=' }, { k:['lá»›n hÆ¡n','trÃªn','hÆ¡n'], v:'>' }, { k:['nhá» hÆ¡n','dÆ°á»›i'], v:'<' }, { k:['báº±ng'], v:'==' }, { k:['vÃ '], v:'&&' }, { k:['hoáº·c'], v:'||' }, { k:['pháº§n trÄƒm','%','chÆ°Æ¡ng','giá»'], v:'' } ]; dict.forEach(r => { r.k.forEach(key => { text = text.replace(new RegExp(key, 'gi'), r.v); }); }); document.getElementById('logicResult').value = text.replace(/\s+/g, ' ').trim(); }

        // PUBLISH
        async function sendToDiscord(ti, sch, time) { const wh = document.getElementById('webhook').value; if(!wh) return; let msg = sch ? `â³ **LÃŠN Lá»ŠCH:** "${ti}" lÃºc: \`${new Date(time).toLocaleString()}\`!` : `ğŸ‰ **CHÆ¯Æ NG Má»šI:** **"${ti}"** Ä‘Ã£ lÃªn sÃ³ng!\nğŸ‘‰ Äá»c ngay: https://${CONFIG.adminUser}.github.io/${CONFIG.repoName}`; try { await fetch(wh, {method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({content:msg, username:"MirAi Bot"})}); } catch(e){} }
        async function publishChapter() { const t=document.getElementById('token').value, ti=document.getElementById('chapTitle').value, c=editor.value(), i=document.getElementById('edit-index').value, sch=document.getElementById('scheduleTime').value, s=document.getElementById('status'); if(!t||!ti||!c)return alert("Thiáº¿u info!"); s.innerText = "â³ Äang xá»­ lÃ½..."; s.style.color="blue"; try { const jR = await fetch(`https://api.github.com/repos/${CONFIG.adminUser}/${CONFIG.repoName}/contents/data.json`, {headers:{Authorization:`token ${t}`}}); const jD = await jR.json(); let list = JSON.parse(decodeURIComponent(escape(atob(jD.content)))); let pt = Date.now(); if(sch) pt = new Date(sch).getTime(); let p, h=null; const fid = `chap_${Date.now()}`; if(i!=="") { p=list[i].file; h=document.getElementById('edit-file-sha').value; list[i].title=ti; list[i].timestamp=pt; } else { p=`chapters/${fid}.md`; list.push({id:fid, title:ti, file:p, timestamp:pt}); } const b64 = btoa(unescape(encodeURIComponent(c))), b = {message: `Upd ${ti}`, content: b64}; if(h) b.sha = h; await githubRequest(p, b); const jB = btoa(unescape(encodeURIComponent(JSON.stringify(list, null, 2)))); await fetch(`https://api.github.com/repos/${CONFIG.adminUser}/${CONFIG.repoName}/contents/data.json`, {method:'PUT', headers:{Authorization:`token ${t}`}, body:JSON.stringify({message: "Upd List", content: jB, sha: jD.sha})}); await sendToDiscord(ti, !!sch, pt); s.innerText = "âœ… THÃ€NH CÃ”NG!"; s.style.color="green"; if(i!=="") switchTab('list'); else resetForm(); } catch(e) { s.innerText = "âŒ Lá»—i: " + e; s.style.color="red"; } }
        function resetForm() { document.getElementById('chapTitle').value=''; editor.value(''); document.getElementById('edit-index').value=''; document.getElementById('edit-file-sha').value=''; document.getElementById('publishBtn').innerText="ğŸš€ ÄÄ‚NG BÃ€I"; document.getElementById('cancelBtn').style.display="none"; document.getElementById('editor-title').innerText="ğŸ“ Soáº¡n Tháº£o"; document.getElementById('scheduleTime').value=''; }
        
        // LOADERS & ACTIONS
        async function loadChapterList() { const t=document.getElementById('token').value; if(!t)return; try{ const res=await fetch(`https://api.github.com/repos/${CONFIG.adminUser}/${CONFIG.repoName}/contents/data.json?t=${Date.now()}`); const d=await res.json(); window.chapters=JSON.parse(decodeURIComponent(escape(atob(d.content)))); window.jsonSha=d.sha; const c=document.getElementById('list-container'); c.innerHTML=''; window.chapters.forEach((h, i)=>{ let st=(h.timestamp && h.timestamp>Date.now())?"â³":"âœ…"; c.innerHTML+=`<div class="chapter-row"><div>#${i+1}: ${h.title} <small>${st}</small></div><div class="action-group"><button class="btn-action edit-btn" onclick="editChap(${i})">âœï¸</button><button class="btn-action del-btn" onclick="delChap(${i})">ğŸ—‘</button></div></div>`; }); }catch(e){document.getElementById('list-container').innerHTML="Lá»—i: "+e;} }
        async function editChap(i) { const c=window.chapters[i]; switchTab('new'); try{ const res=await fetch(`https://api.github.com/repos/${CONFIG.adminUser}/${CONFIG.repoName}/contents/${c.file}?t=${Date.now()}`); const d=await res.json(); document.getElementById('chapTitle').value=c.title; editor.value(decodeURIComponent(escape(atob(d.content)))); document.getElementById('edit-index').value=i; document.getElementById('edit-file-sha').value=d.sha; document.getElementById('editor-title').innerText="âœï¸ Sá»­a: "+c.title; document.getElementById('publishBtn').innerText="ğŸ’¾ Cáº¬P NHáº¬T"; document.getElementById('cancelBtn').style.display="block"; }catch(e){alert("Lá»—i: "+e);} }
        async function delChap(i) { if(!confirm("XÃ³a vÄ©nh viá»…n?")) return; const t=document.getElementById('token').value; try{ const c=window.chapters[i]; const fR=await fetch(`https://api.github.com/repos/${CONFIG.adminUser}/${CONFIG.repoName}/contents/${c.file}`); const fD=await fR.json(); await githubRequest(c.file, {message:"Del", sha:fD.sha}, 'DELETE'); window.chapters.splice(i, 1); const jB=btoa(unescape(encodeURIComponent(JSON.stringify(window.chapters, null, 2)))); await fetch(`https://api.github.com/repos/${CONFIG.adminUser}/${CONFIG.repoName}/contents/data.json`, {method:'PUT', headers:{Authorization:`token ${t}`}, body:JSON.stringify({message:"Del item", content:jB, sha:window.jsonSha})}); alert("ÄÃ£ xÃ³a!"); loadChapterList(); }catch(e){alert("Lá»—i: "+e);} }
        
        async function loadMusicList() { const c=document.getElementById('music-list-container'); c.innerHTML="Loading..."; try{ const res=await fetch(`https://api.github.com/repos/${CONFIG.adminUser}/${CONFIG.repoName}/contents/music.json?t=${Date.now()}`); const d=await res.json(); window.musicData=JSON.parse(decodeURIComponent(escape(atob(d.content)))); window.musicSha=d.sha; c.innerHTML=''; window.musicData.forEach((s,i)=>{ c.innerHTML+=`<div class="chapter-row"><div>ğŸµ ${s.title}</div><button class="btn-action del-btn" onclick="delSong(${i})">ğŸ—‘</button></div>` }); }catch{c.innerHTML="Trá»‘ng"; window.musicData=[];} }
        async function uploadMusic() { const t=document.getElementById('token').value, ti=document.getElementById('songTitle').value, f=document.getElementById('mp3Input').files[0]; if(!t||!ti||!f)return alert("Thiáº¿u info!"); document.getElementById('musicStatus').innerText="Uploading..."; const r=new FileReader(); r.readAsDataURL(f); r.onload=async function(){ try{ const b64=r.result.split(',')[1], p=`images/music/${Date.now()}_${f.name}`; await githubRequest(p, {message:"Up Song", content:b64}); if(!window.musicData) await loadMusicList(); window.musicData.push({title:ti, url:p}); const jB={message:"Up List", content:btoa(unescape(encodeURIComponent(JSON.stringify(window.musicData,null,2))))}; if(window.musicSha) jB.sha=window.musicSha; await fetch(`https://api.github.com/repos/${CONFIG.adminUser}/${CONFIG.repoName}/contents/music.json`, {method:'PUT', headers:{Authorization:`token ${t}`}, body:JSON.stringify(jB)}); alert("Uploaded!"); document.getElementById('songTitle').value=''; loadMusicList(); }catch(e){alert(e);} } }
        async function delSong(i) { if(!confirm("XÃ³a nháº¡c?")) return; const t=document.getElementById('token').value; window.musicData.splice(i, 1); const jB={message:"Del Song", content:btoa(unescape(encodeURIComponent(JSON.stringify(window.musicData, null, 2)))), sha:window.musicSha}; await fetch(`https://api.github.com/repos/${CONFIG.adminUser}/${CONFIG.repoName}/contents/music.json`, {method:'PUT', headers:{Authorization:`token ${t}`}, body:JSON.stringify(jB)}); alert("Deleted!"); loadMusicList(); }

        async function loadAchievements() { const c=document.getElementById('ach-list-container'); c.innerHTML="Loading..."; try{ const res=await fetch(`https://api.github.com/repos/${CONFIG.adminUser}/${CONFIG.repoName}/contents/achievements.json?t=${Date.now()}`); if(!res.ok){window.achData=[]; c.innerHTML="Trá»‘ng"; return;} const d=await res.json(); window.achData=JSON.parse(decodeURIComponent(escape(atob(d.content)))); window.achSha=d.sha; c.innerHTML=''; window.achData.forEach((a,i)=>{ c.innerHTML+=`<div class="ach-item" style="display:flex; justify-content:space-between; align-items:center; padding:10px; margin-bottom:5px; background:white; border-radius:5px; border-left:4px solid #f1c40f"><div>${a.icon} <b>${a.title}</b><br><small style="color:var(--primary); font-family:monospace">${a.condition}</small></div><button class="btn-action del-btn" onclick="delAchievement(${i})">ğŸ—‘</button></div>`; }); }catch(e){c.innerHTML="Lá»—i: "+e;} }
        async function addAchievement() { const id=document.getElementById('achId').value, icon=document.getElementById('achIcon').value, title=document.getElementById('achTitle').value, desc=document.getElementById('achDesc').value, cond=document.getElementById('achCondition').value, t=document.getElementById('token').value; if(!id||!title||!t)return alert("Thiáº¿u info!"); if(!window.achData) window.achData=[]; window.achData.push({id, icon, title, desc, condition: cond}); const jB={message:"Upd Ach", content:btoa(unescape(encodeURIComponent(JSON.stringify(window.achData,null,2))))}; if(window.achSha) jB.sha=window.achSha; await fetch(`https://api.github.com/repos/${CONFIG.adminUser}/${CONFIG.repoName}/contents/achievements.json`, {method:'PUT', headers:{Authorization:`token ${t}`}, body:JSON.stringify(jB)}); alert("Added!"); loadAchievements(); }
        async function delAchievement(i) { if(!confirm("XÃ³a?")) return; const t=document.getElementById('token').value; window.achData.splice(i, 1); const jB={message:"Del Ach", content:btoa(unescape(encodeURIComponent(JSON.stringify(window.achData,null,2)))), sha:window.achSha}; await fetch(`https://api.github.com/repos/${CONFIG.adminUser}/${CONFIG.repoName}/contents/achievements.json`, {method:'PUT', headers:{Authorization:`token ${t}`}, body:JSON.stringify(jB)}); alert("Deleted!"); loadAchievements(); }
        
        const adminBgm = new Audio(); let adminPlaylist = []; let adminTrackIdx = 0;
        async function initAdminMusic() { try{ const res=await fetch(`music.json?t=${Date.now()}`); if(res.ok) adminPlaylist=await res.json(); if(adminPlaylist.length>0){ adminBgm.src=adminPlaylist[0].url; document.getElementById('ap-title').innerText=adminPlaylist[0].title; } }catch(e){} }
        function toggleAdminMusic() { if(adminPlaylist.length===0)return; const icon=document.getElementById('ap-icon'), btn=document.getElementById('ap-play-btn'); if(adminBgm.paused){ adminBgm.play(); icon.classList.add('playing'); btn.innerText='â¸ï¸'; }else{ adminBgm.pause(); icon.classList.remove('playing'); btn.innerText='â–¶ï¸'; } }
        function nextAdminMusic() { if(adminPlaylist.length===0)return; adminTrackIdx++; if(adminTrackIdx>=adminPlaylist.length) adminTrackIdx=0; adminBgm.src=adminPlaylist[adminTrackIdx].url; document.getElementById('ap-title').innerText=adminPlaylist[adminTrackIdx].title; adminBgm.play(); document.getElementById('ap-icon').classList.add('playing'); document.getElementById('ap-play-btn').innerText='â¸ï¸'; }

        async function githubRequest(path, body, method='PUT') { const t = document.getElementById('token').value; return fetch(`https://api.github.com/repos/${CONFIG.adminUser}/${CONFIG.repoName}/contents/${path}`, { method: method, headers: {Authorization: `token ${t}`}, body: JSON.stringify(body) }); }
    </script>
</body>
</html>
