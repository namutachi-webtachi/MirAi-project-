<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MirAi Command Center</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.css">
    
    <style>
        /* --- CORE ADMIN CSS --- */
        body { background-color: #000; margin: 0; overflow: hidden; font-family: 'Consolas', monospace; transition: 0.3s; }
        
        /* M√†n h√¨nh kh√≥a */
        #black-screen { height: 100vh; width: 100vw; display: flex; justify-content: center; align-items: center; color: #0f0; font-size: 1.5rem; background: black; z-index: 9999; transition: opacity 0.5s; position: fixed; top: 0; left: 0;}

        /* Panel ch√≠nh */
        #admin-panel { display: none; padding-bottom: 50px; background: #f4f4f4; min-height: 100vh; overflow-y: auto; transition: 0.3s; }
        
        /* --- DARK MODE ADMIN --- */
        [data-theme="dark"] #admin-panel { background: #1a1a1a; color: #eee; }
        [data-theme="dark"] .glass-box { background: rgba(40, 40, 40, 0.9); border-color: #444; }
        [data-theme="dark"] input, 
        [data-theme="dark"] textarea, 
        [data-theme="dark"] select { background: #333; color: #fff; border-color: #555; }
        [data-theme="dark"] .file-drop { background: #333; color: #ccc; border-color: #555; }
        [data-theme="dark"] .chapter-row, 
        [data-theme="dark"] .draft-item { background: #2d2d2d; border-color: #444; color: #eee; }
        
        /* Fix Dark Mode cho EasyMDE (Editor) */
        [data-theme="dark"] .EasyMDEContainer { background: #2d2d2d; border-color: #444; }
        [data-theme="dark"] .editor-toolbar { background: #333; border-color: #444; }
        [data-theme="dark"] .editor-toolbar i { color: #ccc; }
        [data-theme="dark"] .editor-toolbar i:hover { color: #fff; background: #555; }
        [data-theme="dark"] .CodeMirror { background: #2d2d2d; color: #ddd; border-color: #444; }
        [data-theme="dark"] .CodeMirror-cursor { border-left: 1px solid #fff; }
        [data-theme="dark"] .editor-statusbar { color: #aaa; }

        /* UI Components */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .tab-btn { flex: 1; padding: 12px; cursor: pointer; background: #ddd; border: none; border-radius: 8px; font-weight: bold; min-width: 100px; transition: 0.3s; }
        .tab-btn:hover { background: #ccc; }
        .tab-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        [data-theme="dark"] .tab-btn { background: #444; color: #ccc; }
        [data-theme="dark"] .tab-btn.active { background: var(--primary); color: white; }

        .file-drop { border: 2px dashed #aaa; padding: 20px; text-align: center; border-radius: 10px; cursor: pointer; margin-bottom: 15px; background: white; font-weight: bold; color: #555; transition: 0.3s; }
        .file-drop:hover { border-color: var(--primary); background: rgba(255, 107, 129, 0.1); color: var(--primary); }

        input[type="text"], input[type="password"], input[type="datetime-local"] { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; margin-bottom: 10px; font-family: inherit; font-size: 1rem; box-sizing: border-box; }

        /* EasyMDE Default */
        .EasyMDEContainer { background: white; border-radius: 8px; }
        .editor-toolbar { border-radius: 8px 8px 0 0; border-color: #ddd; }
        .CodeMirror { border-radius: 0 0 8px 8px; border-color: #ddd; min-height: 450px; font-size: 1.05rem; }

        .draft-item, .chapter-row { background: white; padding: 15px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .draft-item { border-left: 4px solid #f39c12; }
        .chapter-row { border-left: 4px solid var(--primary); }

        .btn-action { padding: 6px 12px; border-radius: 6px; cursor: pointer; border: none; color: white; font-weight: bold; margin-left: 5px; font-size: 0.85rem; }
        .edit-btn { background: #f39c12; } .edit-btn:hover { background: #d35400; }
        .del-btn { background: #e74c3c; } .del-btn:hover { background: #c0392b; }
        .open-btn { background: #3498db; } .open-btn:hover { background: #2980b9; }

        #welcome-toast { position: fixed; top: 20px; right: 20px; background: #27ae60; color: white; padding: 15px 25px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); font-weight: bold; transform: translateX(200%); transition: 0.5s; z-index: 10000; }
        #welcome-toast.show { transform: translateX(0); }

        .guide-box { border: 1px dashed #ccc; background: #f9f9f9; border-radius: 8px; margin-bottom: 15px; }
        [data-theme="dark"] .guide-box { background: #333; border-color: #555; }
        .guide-header { padding: 12px; cursor: pointer; font-weight: bold; user-select: none; }
        .guide-content { display: none; padding: 10px 15px; border-top: 1px dashed #ccc; }
        .guide-content ul { margin: 0; padding-left: 20px; }
    </style>
</head>
<body>

    <div id="welcome-toast">üëã Welcome back, Commander.</div>
    <div id="black-screen"><p>SYSTEM HALTED. PRESS F12 > CONSOLE > LOGIN.</p></div>

    <div id="admin-panel" class="container">
        <header class="glass-box" style="text-align: center; margin-top: 30px;">
            <h2 style="color: var(--primary);">‚ò†Ô∏è MIRAI COMMAND CENTER</h2>
            <div style="margin-top: 15px;">
                <button class="btn" onclick="toggleAdminTheme()">üåó Giao di·ªán: S√°ng/T·ªëi</button>
                <a href="index.html" class="btn btn-outline">‚¨Ö Quay v·ªÅ Web</a>
            </div>
        </header>

        <div class="glass-box">
            <h3>üîë C·∫•u h√¨nh & K·∫øt n·ªëi</h3>
            <input type="password" id="token" placeholder="GitHub Token (ghp_...)" onchange="saveConfig()">
            <input type="password" id="webhook" placeholder="Discord Webhook URL..." onchange="saveConfig()">
            <small style="color: #666; display: block; margin-top: 5px;">*Token ƒë∆∞·ª£c l∆∞u an to√†n trong tr√¨nh duy·ªát.</small>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('new')">üìù So·∫°n Th·∫£o</button>
            <button class="tab-btn" onclick="switchTab('drafts')">üíæ B·∫£n Nh√°p</button>
            <button class="tab-btn" onclick="switchTab('list')">üìã Qu·∫£n L√Ω Truy·ªán</button>
            <button class="tab-btn" onclick="switchTab('music')">üéµ DJ Station</button>
        </div>

        <!-- TAB 1: EDITOR -->
        <div id="tab-editor" class="glass-box">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3 id="editor-title" style="margin: 0;">üìù So·∫°n Th·∫£o Ch∆∞∆°ng M·ªõi</h3>
                <span id="auto-save-status" style="font-size: 0.8rem; opacity: 0.7;">S·∫µn s√†ng</span>
            </div>
            <hr style="margin: 15px 0; border: 0; border-top: 1px dashed #ccc;">

            <input type="hidden" id="edit-index" value=""><input type="hidden" id="edit-file-sha" value="">
            <input type="text" id="chapTitle" placeholder="Ti√™u ƒë·ªÅ ch∆∞∆°ng (V√≠ d·ª•: Ch∆∞∆°ng 1: Kh·ªüi ƒë·∫ßu)">
            
            <div class="guide-box">
                <div class="guide-header" onclick="document.getElementById('gc').style.display=document.getElementById('gc').style.display=='block'?'none':'block'">üìö Ph√≠m t·∫Øt & Quy t·∫Øc (B·∫•m xem)</div>
                <div class="guide-content" id="gc">
                    <ul>
                        <li><b>Ctrl + S:</b> L∆∞u b·∫£n nh√°p.</li>
                        <li><b>[T√™n]:</b> T·ª± ƒë·ªông in ƒë·∫≠m (d√πng Auto Format).</li>
                        <li><b>(...)</b>: T·ª± ƒë·ªông in nghi√™ng.</li>
                        <li><b>***</b>: T·∫°o d√≤ng k·∫ª ngang.</li>
                    </ul>
                </div>
            </div>

            <!-- N√∫t Link ƒë·∫øn AI Studio -->
            <div style="margin-bottom: 15px;">
                <a href="https://aistudio.google.com/prompts/1wYeI98PvvZuZZZTvg8D1SbIfJR6KveFO" target="_blank" class="btn" style="width: 100%; background: linear-gradient(45deg, #4285F4, #9B72CB); text-align: center; justify-content: center; box-sizing: border-box;">üß† M·ªü AI Studio (Edit Truy·ªán)</a>
            </div>

            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <div class="file-drop" style="flex:1" onclick="document.getElementById('txtInput').click()">
                    üìÇ Import File TXT 
                    <input type="file" id="txtInput" accept=".txt" hidden onchange="handleTxtImport()">
                </div>
                <div class="file-drop" style="flex:1" onclick="document.getElementById('imgInput').click()">
                    üñº Upload ·∫¢nh (Si√™u N√©n)
                    <input type="file" id="imgInput" accept="image/*" hidden onchange="handleImgUpload()">
                </div>
            </div>
            <p id="imgStatus" style="text-align: center; color: var(--primary); font-size: 0.9rem; margin-bottom: 10px; font-weight: bold;"></p>

            <button class="btn" onclick="runAutoFormat()" style="width: 100%; background: #2ecc71; margin-bottom: 15px;">‚ú® T·ª± ƒê·ªông ƒê·ªãnh D·∫°ng (Local)</button>
            
            <textarea id="content"></textarea>
            
            <div style="background: rgba(0,0,0,0.05); padding: 15px; border-radius: 8px; margin-top: 15px;">
                <label style="font-weight: bold;">‚è∞ H·∫πn gi·ªù ƒëƒÉng (T√πy ch·ªçn):</label>
                <input type="datetime-local" id="scheduleTime" style="margin-top: 5px;">
                <small style="display: block; margin-top: 5px; opacity: 0.7;">ƒê·ªÉ tr·ªëng = ƒêƒÉng ngay l·∫≠p t·ª©c.</small>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn" onclick="saveDraft()" style="background: #f39c12; flex: 1;">üíæ L∆∞u Nh√°p (Ctrl+S)</button>
                <button id="publishBtn" class="btn" onclick="publishChapter()" style="flex: 1;">üöÄ ƒêƒÇNG B√ÄI</button>
            </div>
            
            <button id="cancelBtn" class="btn" onclick="resetForm()" style="width: 100%; margin-top: 10px; background: #7f8c8d; display: none;">H·ªßy Ch·∫ø ƒê·ªô S·ª≠a</button>
            <p id="status" style="text-align: center; font-weight: bold; margin-top: 15px; font-size: 1.1rem;"></p>
        </div>

        <!-- TAB 2: DRAFTS -->
        <div id="tab-drafts" class="glass-box" style="display: none;"><h3>üíæ Kho B·∫£n Nh√°p</h3><div id="draft-list"></div></div>

        <!-- TAB 3: LIST -->
        <div id="tab-list" class="glass-box" style="display: none;"><h3>üìã Danh s√°ch ch∆∞∆°ng</h3><button class="btn btn-outline" onclick="loadChapterList()" style="width: 100%; margin-bottom: 15px;">üîÑ L√†m m·ªõi danh s√°ch</button><div id="list-container">Loading...</div></div>

        <!-- TAB 4: MUSIC -->
        <div id="tab-music" class="glass-box" style="display: none;">
            <h3>üéµ Upload Nh·∫°c</h3>
            <input type="text" id="songTitle" placeholder="T√™n b√†i h√°t (VD: Nh·∫°c n·ªÅn ƒëo·∫°n cao tr√†o)">
            <div class="file-drop" onclick="document.getElementById('mp3Input').click()">üíø Ch·ªçn MP3 <input type="file" id="mp3Input" accept=".mp3" hidden></div>
            <button class="btn" onclick="uploadMusic()" style="width: 100%;">‚¨ÜÔ∏è Upload v√†o Playlist</button>
            <p id="musicStatus" style="text-align: center; margin-top: 10px; font-weight: bold;"></p>
            <hr style="margin: 20px 0;">
            <h3>üéº Danh s√°ch ph√°t hi·ªán t·∫°i</h3>
            <button class="btn btn-outline" onclick="loadMusicList()" style="width: 100%; margin-bottom: 15px;">üîÑ Refresh List</button>
            <div id="music-list-container">Loading...</div>
        </div>
    </div>

    <!-- LIB -->
    <script src="config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/compressorjs/1.2.1/compressor.min.js"></script>
    
    <script>
        const SECRET_PASS = "2006";
        var editor = new EasyMDE({ 
            element: document.getElementById("content"),
            spellChecker: false,
            placeholder: "Vi·∫øt g√¨ ƒë√≥ th·∫≠t ch√°y ƒëi Commander...",
            autosave: { enabled: true, uniqueId: "MirAi_AutoSave", delay: 10000 },
            status: ["lines", "words", "cursor"], 
            toolbar: ["bold", "italic", "heading", "|", "quote", "unordered-list", "ordered-list", "|", "link", "image", "|", "preview", "side-by-side", "fullscreen"] 
        });

        // --- DARK MODE LOGIC ---
        function toggleAdminTheme() {
            const body = document.body;
            const current = body.getAttribute('data-theme');
            const next = current === 'dark' ? 'light' : 'dark';
            body.setAttribute('data-theme', next);
            localStorage.setItem('admin_theme', next);
        }
        // Load theme khi m·ªü
        if (localStorage.getItem('admin_theme') === 'dark') {
            document.body.setAttribute('data-theme', 'dark');
        }

        // --- AUTH & INIT ---
        document.addEventListener("DOMContentLoaded", () => {
            const token = localStorage.getItem('gh_token');
            if (token) { unlockInterface(); document.getElementById('token').value = token; showWelcome(); }
            if (localStorage.getItem('discord_webhook')) document.getElementById('webhook').value = localStorage.getItem('discord_webhook');
            loadDraftsUI();
        });
        function showWelcome() { const t = document.getElementById('welcome-toast'); t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 3000); }
        window.login = function(pass) { if(pass === SECRET_PASS) { unlockInterface(); saveConfig(); showWelcome(); } else console.log("WRONG PASS"); }
        function unlockInterface() { document.getElementById('black-screen').style.display = 'none'; document.getElementById('admin-panel').style.display = 'block'; } // B·ªè set background c·ª©ng ƒë·ªÉ CSS dark mode ho·∫°t ƒë·ªông
        function saveConfig() { localStorage.setItem('gh_token', document.getElementById('token').value); localStorage.setItem('discord_webhook', document.getElementById('webhook').value); }
        function switchTab(t) { document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); document.querySelectorAll('.glass-box[id^="tab-"]').forEach(d => d.style.display = 'none'); document.getElementById(`tab-${t === 'new' ? 'editor' : t}`).style.display = 'block'; document.querySelector(`button[onclick="switchTab('${t}')"]`).classList.add('active'); if(t === 'list') loadChapterList(); if(t === 'music') loadMusicList(); }

        // --- CORE FUNCTIONS ---
        document.addEventListener('keydown', e => { if (e.ctrlKey && e.key === 's') { e.preventDefault(); saveDraft(); } });
        function saveDraft() {
            const title = document.getElementById('chapTitle').value; const content = editor.value();
            if(!title && !content) return alert("Vi·∫øt g√¨ ƒë√≥ ƒë√£!");
            const drafts = JSON.parse(localStorage.getItem('mirai_drafts') || "[]");
            const newDraft = { id: Date.now(), title: title || "Kh√¥ng ti√™u ƒë·ªÅ", content, date: new Date().toLocaleString() };
            const idx = drafts.findIndex(d => d.title === title);
            if(idx !== -1 && title) drafts[idx] = newDraft; else drafts.unshift(newDraft);
            localStorage.setItem('mirai_drafts', JSON.stringify(drafts));
            document.getElementById('auto-save-status').innerText = "‚úÖ ƒê√£ l∆∞u l√∫c " + new Date().toLocaleTimeString();
            document.getElementById('auto-save-status').style.color = "green";
            loadDraftsUI();
        }
        function loadDraftsUI() {
            const drafts = JSON.parse(localStorage.getItem('mirai_drafts') || "[]");
            const c = document.getElementById('draft-list'); c.innerHTML = drafts.length ? "" : "<p>Ch∆∞a c√≥ b·∫£n nh√°p.</p>";
            drafts.forEach((d, i) => { c.innerHTML += `<div class="draft-item"><div><b>${d.title}</b> <br> <small>${d.date}</small></div><div><button class="btn-action open-btn" onclick="openDraft(${i})">M·ªü</button><button class="btn-action del-btn" onclick="deleteDraft(${i})">X√≥a</button></div></div>`; });
        }
        function openDraft(i) { const drafts = JSON.parse(localStorage.getItem('mirai_drafts') || "[]"); document.getElementById('chapTitle').value = drafts[i].title; editor.value(drafts[i].content); switchTab('new'); }
        function deleteDraft(i) { if(!confirm("X√≥a nh√°p?")) return; const drafts = JSON.parse(localStorage.getItem('mirai_drafts') || "[]"); drafts.splice(i, 1); localStorage.setItem('mirai_drafts', JSON.stringify(drafts)); loadDraftsUI(); }

        function handleTxtImport() { const r = new FileReader(); r.onload = e => { let txt = e.target.result.replace(/\r\n/g,"\n").replace(/\n/g,"\n\n"); editor.value(txt); }; r.readAsText(document.getElementById('txtInput').files[0]); }
        
        // --- SUPER COMPRESSION IMAGE UPLOAD ---
        function handleImgUpload() { 
            const f = document.getElementById('imgInput').files[0]; 
            if(!f) return; 
            const t = document.getElementById('token').value; 
            const status = document.getElementById('imgStatus');
            status.innerText = "‚è≥ ƒêang x·ª≠ l√Ω v√† n√©n ·∫£nh...";
            
            // √âp n√©n v·ªÅ JPEG ch·∫•t l∆∞·ª£ng 60%
            new Compressor(f, {
                quality: 0.6, 
                maxWidth: 1200, 
                mimeType: 'image/jpeg', // Ch√¨a kh√≥a v√†ng: Lu√¥n convert sang JPEG
                success(result) {
                    status.innerText = "‚è≥ ƒêang upload ·∫£nh n√©n...";
                    const r = new FileReader();
                    r.readAsDataURL(result);
                    r.onload = async function() {
                        try {
                            const b64 = r.result.split(',')[1];
                            const n = `images/${Date.now()}_optimized.jpg`; // ƒêu√¥i lu√¥n l√† jpg
                            await githubRequest(n, {message: "upload optimized img", content: b64});
                            
                            const url = `https://${CONFIG.adminUser}.github.io/${CONFIG.repoName}/${n}`;
                            const cm = editor.codemirror;
                            cm.getDoc().replaceRange(`\n![Minh h·ªça](${url})\n`, cm.getDoc().getCursor());
                            status.innerText = `‚úÖ ƒê√£ xong! (G·ªëc: ${(f.size/1024).toFixed(1)}KB -> N√©n: ${(result.size/1024).toFixed(1)}KB)`;
                        } catch(e) { alert("L·ªói: " + e); status.innerText = ""; }
                    };
                },
                error(err) { alert(err.message); status.innerText = ""; },
            });
        }

        function runAutoFormat() { let txt = editor.value().replace(/\r\n/g,"\n").replace(/\n{2,}/g,"\n\n").replace(/(?<!\n)\n(?!\n)/g,"\n\n").replace(/^\[(.*?)\]:\s*(.*)$/gm, '**[$1]:** $2').replace(/\((.*?)\)/g, '*($1)*').replace(/^\s*\*\*\*\s*$/gm, '---'); editor.value(txt); alert("‚úÖ ƒê√£ ƒë·ªãnh d·∫°ng xong!"); }

        async function sendToDiscord(title, isScheduled, time) {
            const wh = document.getElementById('webhook').value; if(!wh) return;
            let msg = isScheduled ? `‚è≥ **L√äN L·ªäCH:** Ch∆∞∆°ng "${title}" s·∫Ω ph√°t h√†nh l√∫c: \`${new Date(time).toLocaleString()}\`!` : `üéâ **CH∆Ø∆†NG M·ªöI:** **"${title}"** ƒë√£ l√™n s√≥ng!\nüëâ ƒê·ªçc ngay t·∫°i: https://${CONFIG.adminUser}.github.io/${CONFIG.repoName}`;
            try { await fetch(wh, {method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({content:msg, username:"MirAi Bot"})}); } catch(e){console.error(e);}
        }

        async function publishChapter() {
            const t = document.getElementById('token').value, ti = document.getElementById('chapTitle').value, c = editor.value(), i = document.getElementById('edit-index').value;
            const sch = document.getElementById('scheduleTime').value; const s = document.getElementById('status');
            if(!t || !ti || !c) return alert("Thi·∫øu th√¥ng tin!");
            s.innerText = "‚è≥ ƒêang k·∫øt n·ªëi GitHub..."; s.style.color = "blue";
            try {
                const jR = await fetch(`https://api.github.com/repos/${CONFIG.adminUser}/${CONFIG.repoName}/contents/data.json`, {headers:{Authorization:`token ${t}`}});
                const jD = await jR.json(); let list = JSON.parse(decodeURIComponent(escape(atob(jD.content))));
                let pubTime = Date.now(); if(sch) pubTime = new Date(sch).getTime();
                
                let p,h=null; const fileId = `chap_${Date.now()}`;
                if(i !== "") { p = list[i].file; h = document.getElementById('edit-file-sha').value; list[i].title = ti; list[i].timestamp = pubTime; } 
                else { p = `chapters/${fileId}.md`; list.push({id: fileId, title: ti, file: p, timestamp: pubTime}); }
                
                const b64 = btoa(unescape(encodeURIComponent(c))), b = {message: `Update ${ti}`, content: b64}; if(h) b.sha = h;
                await fetch(`https://api.github.com/repos/${CONFIG.adminUser}/${CONFIG.repoName}/contents/${p}`, {method:'PUT', headers:{Authorization:`token ${t}`}, body:JSON.stringify(b)});
                
                const jB = btoa(unescape(encodeURIComponent(JSON.stringify(list, null, 2))));
                await fetch(`https://api.github.com/repos/${CONFIG.adminUser}/${CONFIG.repoName}/contents/data.json`, {method:'PUT', headers:{Authorization:`token ${t}`}, body:JSON.stringify({message: "Update Chapter List", content: jB, sha: jD.sha})});
                
                await sendToDiscord(ti, !!sch, pubTime);
                s.innerText = "‚úÖ TH√ÄNH C√îNG!"; s.style.color = "green";
                if(i !== "") switchTab('list'); else resetForm();
            } catch(e) { s.innerText = "‚ùå L·ªói: " + e; s.style.color = "red"; }
        }

        function resetForm() { document.getElementById('chapTitle').value=''; editor.value(''); document.getElementById('edit-index').value='';document.getElementById('edit-file-sha').value=''; document.getElementById('publishBtn').innerText="üöÄ ƒêƒÇNG B√ÄI"; document.getElementById('cancelBtn').style.display="none"; document.getElementById('editor-title').innerText="üìù So·∫°n Th·∫£o"; document.getElementById('scheduleTime').value=''; }
        async function loadChapterList() { const t = document.getElementById('token').value; if(!t) return; try { const res = await fetch(`https://api.github.com/repos/${CONFIG.adminUser}/${CONFIG.repoName}/contents/data.json?t=${Date.now()}`); const data = await res.json(); window.chapters = JSON.parse(decodeURIComponent(escape(atob(data.content)))); window.jsonSha = data.sha; const c = document.getElementById('list-container'); c.innerHTML = ''; window.chapters.forEach((h, i) => { let status = (h.timestamp && h.timestamp > Date.now()) ? "‚è≥" : "‚úÖ"; c.innerHTML += `<div class="chapter-row"><div>#${i+1}: ${h.title} <small>${status}</small></div><div class="action-group"><button class="btn-action edit-btn" onclick="editChap(${i})">‚úèÔ∏è</button><button class="btn-action del-btn" onclick="delChap(${i})">üóë</button></div></div>`; }); } catch(e) { document.getElementById('list-container').innerHTML = "L·ªói: " + e; } }
        async function editChap(i) { const c = window.chapters[i]; switchTab('new'); try { const res = await fetch(`https://api.github.com/repos/${CONFIG.adminUser}/${CONFIG.repoName}/contents/${c.file}?t=${Date.now()}`); const d = await res.json(); document.getElementById('chapTitle').value = c.title; editor.value(decodeURIComponent(escape(atob(d.content)))); document.getElementById('edit-index').value = i; document.getElementById('edit-file-sha').value = d.sha; document.getElementById('editor-title').innerText = "‚úèÔ∏è ƒêang S·ª≠a: " + c.title; document.getElementById('publishBtn').innerText = "üíæ C·∫¨P NH·∫¨T"; document.getElementById('cancelBtn').style.display = "block"; } catch(e) { alert("L·ªói: " + e); } }
        async function delChap(i) { if(!confirm("X√≥a vƒ©nh vi·ªÖn?")) return; const t = document.getElementById('token').value; try { const c = window.chapters[i]; const fR = await fetch(`https://api.github.com/repos/${CONFIG.adminUser}/${CONFIG.repoName}/contents/${c.file}`); const fD = await fR.json(); await fetch(`https://api.github.com/repos/${CONFIG.adminUser}/${CONFIG.repoName}/contents/${c.file}`, {method:'DELETE', headers:{Authorization:`token ${t}`}, body:JSON.stringify({message:"Del", sha:fD.sha})}); window.chapters.splice(i, 1); const jB = btoa(unescape(encodeURIComponent(JSON.stringify(window.chapters, null, 2)))); await fetch(`https://api.github.com/repos/${CONFIG.adminUser}/${CONFIG.repoName}/contents/data.json`, {method:'PUT', headers:{Authorization:`token ${t}`}, body:JSON.stringify({message:"Del item", content:jB, sha:window.jsonSha})}); alert("ƒê√£ x√≥a!"); loadChapterList(); } catch(e) { alert("L·ªói: " + e); } }
        
        async function loadMusicList() { const t = document.getElementById('token').value; const c = document.getElementById('music-list-container'); c.innerHTML = "Loading..."; try { const res = await fetch(`https://api.github.com/repos/${CONFIG.adminUser}/${CONFIG.repoName}/contents/music.json?t=${Date.now()}`); const d = await res.json(); window.musicData = JSON.parse(decodeURIComponent(escape(atob(d.content)))); window.musicSha = d.sha; c.innerHTML = ''; window.musicData.forEach((s, i) => { c.innerHTML += `<div class="chapter-row"><div>üéµ ${s.title}</div><button class="btn-action del-btn" onclick="delSong(${i})">üóë</button></div>` }); } catch { c.innerHTML = "Tr·ªëng"; window.musicData = []; } }
        async function uploadMusic() { const t = document.getElementById('token').value, ti = document.getElementById('songTitle').value, f = document.getElementById('mp3Input').files[0]; if(!t || !ti || !f) return alert("Thi·∫øu info!"); document.getElementById('musicStatus').innerText = "Uploading..."; const r = new FileReader(); r.readAsDataURL(f); r.onload = async function() { try { const b64 = r.result.split(',')[1]; const p = `images/music/${Date.now()}_${f.name}`; await fetch(`https://api.github.com/repos/${CONFIG.adminUser}/${CONFIG.repoName}/contents/${p}`, {method:'PUT', headers:{Authorization:`token ${t}`}, body:JSON.stringify({message:"Up Song", content:b64})}); if(!window.musicData) await loadMusicList(); window.musicData.push({title:ti, url:p}); const jB = {message:"Up List", content:btoa(unescape(encodeURIComponent(JSON.stringify(window.musicData, null, 2))))}; if(window.musicSha) jB.sha = window.musicSha; await fetch(`https://api.github.com/repos/${CONFIG.adminUser}/${CONFIG.repoName}/contents/music.json`, {method:'PUT', headers:{Authorization:`token ${t}`}, body:JSON.stringify(jB)}); alert("Uploaded!"); document.getElementById('songTitle').value = ''; loadMusicList(); } catch(e) { alert(e); } } }
        async function delSong(i) { if(!confirm("X√≥a nh·∫°c?")) return; const t = document.getElementById('token').value; window.musicData.splice(i, 1); const jB = {message:"Del Song", content:btoa(unescape(encodeURIComponent(JSON.stringify(window.musicData, null, 2)))), sha:window.musicSha}; await fetch(`https://api.github.com/repos/${CONFIG.adminUser}/${CONFIG.repoName}/contents/music.json`, {method:'PUT', headers:{Authorization:`token ${t}`}, body:JSON.stringify(jB)}); alert("Deleted!"); loadMusicList(); }
        
        async function githubRequest(path, body) { const t = document.getElementById('token').value; return fetch(`https://api.github.com/repos/${CONFIG.adminUser}/${CONFIG.repoName}/contents/${path}`, { method: 'PUT', headers: {Authorization: `token ${t}`}, body: JSON.stringify(body) }); }
    </script>
</body>
</html>
