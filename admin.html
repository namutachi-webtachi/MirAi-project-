<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>MirAi Admin</title>
    <link rel="stylesheet" href="css/style.css">
    <style> .status { margin-top: 10px; font-weight: bold; text-align: center; } </style>
</head>
<body>
    <div class="container">
        <header class="glass-box" style="text-align: center;">
            <h2>üõ† ƒêƒÉng Truy·ªán T·ª± ƒê·ªông</h2>
            <a href="index.html" class="btn btn-outline">‚¨Ö V·ªÅ Web</a>
        </header>

        <div class="glass-box">
            <h3>üîë C·∫•u h√¨nh Token</h3>
            <input type="password" id="token" placeholder="D√°n GitHub Token c·ªßa c·∫≠u v√†o ƒë√¢y (ghp_...)" onchange="saveToken()">
            <p style="font-size: 0.8rem; color: #666;">*Token ƒë∆∞·ª£c l∆∞u v√†o tr√¨nh duy·ªát c·ªßa c·∫≠u, an to√†n tuy·ªát ƒë·ªëi.</p>
        </div>

        <div class="glass-box">
            <h3>üìù So·∫°n th·∫£o</h3>
            
            <label>Ti√™u ƒë·ªÅ ch∆∞∆°ng:</label>
            <input type="text" id="chapTitle" placeholder="VD: Ch∆∞∆°ng 10: Cao tr√†o">

            <div class="file-drop" onclick="document.getElementById('txtInput').click()">
                <input type="file" id="txtInput" accept=".txt" hidden onchange="handleTxt()">
                üìÇ <b>B·∫•m ƒë·ªÉ ch·ªçn file .TXT</b> (Tool s·∫Ω t·ª± copy v√†o khung so·∫°n th·∫£o)
            </div>

            <div class="file-drop" onclick="document.getElementById('imgInput').click()">
                <input type="file" id="imgInput" accept="image/*" hidden onchange="handleImg()">
                üñº <b>B·∫•m ƒë·ªÉ ch·ªçn ·∫¢nh minh h·ªça</b> (T·ª± upload v√† ch√®n link)
            </div>
            <p id="imgStatus" style="text-align: center; font-size: 0.9rem; color: var(--primary);"></p>

            <textarea id="content" rows="15" placeholder="N·ªôi dung truy·ªán (Markdown)..."></textarea>
            
            <button class="btn" onclick="publish()" style="width: 100%; justify-content: center; font-size: 1.2rem;">üöÄ ƒêƒÇNG NGAY</button>
            <div id="status" class="status"></div>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        // Token logic
        if(localStorage.getItem('gh_token')) document.getElementById('token').value = localStorage.getItem('gh_token');
        function saveToken() { localStorage.setItem('gh_token', document.getElementById('token').value); }

        // X·ª≠ l√Ω file TXT
        function handleTxt() {
            const file = document.getElementById('txtInput').files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                let text = e.target.result;
                // T·ª± ƒë·ªông ƒë·ªãnh d·∫°ng l·∫°i ƒëo·∫°n vƒÉn cho chu·∫©n Markdown
                text = text.replace(/\r\n/g, "\n").replace(/\n/g, "\n\n");
                document.getElementById('content').value = text;
            };
            reader.readAsText(file);
        }

        // X·ª≠ l√Ω Upload ·∫¢nh
        async function handleImg() {
            const file = document.getElementById('imgInput').files[0];
            if(!file) return;
            const token = document.getElementById('token').value;
            if(!token) return alert("C·∫ßn Token ƒë·ªÉ up ·∫£nh!");

            document.getElementById('imgStatus').innerText = "‚è≥ ƒêang upload ·∫£nh...";
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = async function() {
                try {
                    const base64 = reader.result.split(',')[1];
                    const fileName = `images/${Date.now()}_${file.name}`;
                    await githubReq(fileName, base64, "Up ·∫£nh minh h·ªça", token);
                    
                    const imgUrl = `https://${CONFIG.adminUser}.github.io/${CONFIG.repoName}/${fileName}`;
                    const mdTag = `\n![Minh h·ªça](${imgUrl})\n`;
                    
                    const txtArea = document.getElementById('content');
                    txtArea.value = mdTag + txtArea.value;
                    document.getElementById('imgStatus').innerText = "‚úÖ ƒê√£ ch√®n ·∫£nh v√†o b√†i vi·∫øt!";
                } catch(e) { alert("L·ªói up ·∫£nh: " + e); }
            }
        }

        // ƒêƒÉng b√†i
        async function publish() {
            const token = document.getElementById('token').value;
            const title = document.getElementById('chapTitle').value;
            const content = document.getElementById('content').value;
            const status = document.getElementById('status');

            if(!token || !title || !content) return alert("Thi·∫øu th√¥ng tin!");
            
            status.innerText = "‚è≥ ƒêang x·ª≠ l√Ω...";
            status.style.color = "blue";

            try {
                // 1. Up file ch∆∞∆°ng
                const fileId = `chap_${Date.now()}`;
                const filePath = `chapters/${fileId}.md`;
                const contentB64 = btoa(unescape(encodeURIComponent(content)));
                await githubReq(filePath, contentB64, `New chap: ${title}`, token);

                // 2. L·∫•y data.json c≈©
                const jsonUrl = `https://api.github.com/repos/${CONFIG.adminUser}/${CONFIG.repoName}/contents/data.json`;
                const getRes = await fetch(jsonUrl, { headers: {Authorization: `token ${token}`} });
                let list = [], sha = null;
                
                if(getRes.ok) {
                    const data = await getRes.json();
                    sha = data.sha;
                    list = JSON.parse(decodeURIComponent(escape(atob(data.content))));
                }

                // 3. C·∫≠p nh·∫≠t list
                list.push({ id: fileId, title: title, file: filePath });
                const jsonB64 = btoa(unescape(encodeURIComponent(JSON.stringify(list, null, 2))));
                await githubReq("data.json", jsonB64, "Update list", token, sha);

                status.innerText = "üéâ TH√ÄNH C√îNG! ƒê·ª£i 1 ph√∫t r·ªìi F5 trang ch·ªß.";
                status.style.color = "green";
                document.getElementById('content').value = '';
                document.getElementById('chapTitle').value = '';

            } catch(e) {
                console.error(e);
                status.innerText = "‚ùå L·ªói: " + e.message;
                status.style.color = "red";
            }
        }

        async function githubReq(path, content, msg, token, sha=null) {
            const body = { message: msg, content: content };
            if(sha) body.sha = sha;
            const res = await fetch(`https://api.github.com/repos/${CONFIG.adminUser}/${CONFIG.repoName}/contents/${path}`, {
                method: 'PUT',
                headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            if(!res.ok) throw new Error((await res.json()).message);
        }
    </script>
</body>
</html>
